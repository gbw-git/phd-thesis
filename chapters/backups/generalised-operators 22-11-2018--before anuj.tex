% !TEX root = ../main/thesis.tex
\documentclass[../main/thesis.tex]{subfiles}
\begin{document}
We know that both that $\FP$ captures $\PT$ over linearly ordered structures and
that $\FP$ fails to express low-complexity queries in $\PT$ over arbitrary
structures. This observation has led to the study of extensions of $\FP$ with a
separate ordered number domain along with a set of set of `operators' (e.g.\
rank or counting operators) that mediate between the structure and the ordered
domain.

However, the notion of an operator has remained quite informal, and new
operators are usually defined in an ad hoc manner. In contrast, we have a theory
of generalised quantifiers due to {\lindstrom}. In this theory a quantifier is
defined by a class of structures and an extension of a logic by a quantifier is
defined using interpretations. In this chapter we introduce a theory of
\emph{generalised operators}. These operators are similarly defined by a class
of structures, but in this case the structures are many-sorted and may include
both relations and number-valued functions. Unlike for quantifiers, the
evaluation of an operator is determined both by a structure and a sequence of
\emph{parameters}, generalising the parameters used in the definition of a rank
operator by {\gradel} and Pakusa~\cite{GradelP15a}. Lastly, an operator may
evaluate to a Boolean value, and so define a formula, or a numerical value, and
so define a number-term.

In this chapter we also introduce a novel generalisation of the {\lindstrom}
quantifier, which we call an \emph{extended quantifier}. It is known that each formula
of fixed-point with counting \emph{operators} can be translated to a formula of
bounded-variable infinitary logic with counting \emph{quantifiers}. We
generalise this result, and show that formulas of fixed-point logic extended by
generalised operators can be translated to formulas of bounded-variable
infinitary logic with extended quantifiers. As an intermediary step, we also
introduce the notion of a \emph{substitution-program}. We think of substitution
programs as a means of compactly representing fixed-point formulas. We use
substitution-programs again in Chapter~\ref{chpt:formulas-to-circuits} when we
translate formulas of fixed-point logic to families of symmetric circuits.

This chapter is organised as follows. In
Section~\ref{chpt:gen-op--sec:num-valued-vocab} we formally define a many-sorted
vocabulary with number-valued function symbols and generalise the notion of an
interpretation to these vocabularies. In
Section~\ref{chpt:gen-op--sec:generalised-operators} we introduce generalised
operators and extensions of logics by these operators. In
Section~\ref{chpt:gen-op--sec:extended-quantifiers} we introduce extended
quantifiers and show that each family of generalised operators has a
corresponding family of extended quantifiers. In
Section~\ref{chpt:gen-op--sec:substitution-programs} we introduce substitution
programs and show that formulas of fixed-point logics extended by generalised
operators can be translated to $\PT$-uniform families of substitution programs.
In Section~\ref{chpt:gen-op--sec:fp-to-inf} we complete the translation from a
fixed-point logic with generalised operators to bounded-variable infinitary
logic extended by the corresponding family of extended quantifiers.


% In this chapter we formally define a generalised operator and show how to
% extend a logic by an operator. We first define a many-sorted vocabulary with
% function symbols, and what a structure

% and an operator is determined not just by These operators go beyond
% quantiifers in two further respects,


% The operators differ in also allowing for a set of paremeters (generalising
% the prime specificed )The evaluation of an operator determined by an
% evaluation function $E$ that maps a structure, similarly defined by an
% interpretation, and a seuqnece of is specified both by a structure defined by
% an interpretation but also by a sequence of number-terms that act as
% parameters.

% These operators are similarly defined by a class of structures, but in the
% case the class of structures


% generalised operators act on a sequence of number terms and formulas and
% define a number term. Generalised operators also allow for the inclusion of a
% parameter, similar to the parameter given in the definition of a rank operator
% by Gradel and Pakusa~\cite{}.



% In this chapter we introduce such a

% This led to the introduction of $\FP^{\nats}$, an extension of $\FP$ that
% allows for reasoning over either the domain of the structure or a separate,
% ordered, number sort. This logic allows us to study the role of order and
% counting by studying what sorts o



% In order to both study the role of order and to include some mechanism for
% counting, much research since then has focused on extensions of $\FP^{\nats}$
% which allows a formula to refer either to the domain of the structure (the
% element sort) or to a separate ordered copy of the domain of the structure
% (the number sort). This has lead to the study of logics that relate these two
% domains in some way, for example $\FPC$ extends $\FP^{\nats}$ with an operator
% that defines a number term from a formula, with the number term denoting the
% cardinality of the set defined by the formula.

% In this chapter we introduce \emph{generalised operators}. In the same way
% Lindestr\"{o}m quantifiers generalise existential and universal quantifiers,
% generalised operators generalise counting and rank operators. As such,
% generalised operators act on a sequence of number terms and formulas and
% define a number term. Generalised operators also allow for the inclusion of a
% parameter, similar to the parameter given in the definition of a rank operator
% by Gradel and Pakusa~\cite{}.

% We know that each formula in $\FP$ is equivalent to a formula in
% $\mathcal{L}^{\omega}$ and each formula in $\FPC$ is equivalent to a formula
% in $\mathcal{C}^{\omega}$. These translations from fixed-point logics to
% infinitary logics have been crucial for proving almost all key separation
% results (see~\cite{}). In this chapter we define what we call
% \emph{substitution programs} and show that formulas of $\FP^{\nats}$ extended
% by a family of operators may be translated to appropriate $\PT$-uniform
% families of substitution programs. These $\PT$-uniform families of
% substitution programs may in turn be translated into formula in an extension
% of $\mathcal{L}^{\omega}$ by a corresponding family of \emph{extended
% quantifiers}.

% We also show that these $\PT$-uniform substitution programs may be translated
% to $\PT$-uniform families of transparent symmetric circuits. This result gives
% us a complete translation from extension of $\FP^{\nats}$ by operators to
% $\PT$-uniform families of symmetric circuits. In the final section of this
% chapter we discuss some special cases.





% The translation from fixed-point logics to

% We show that each set of operators (or quantifiers) may be translated to a In
% the final section of this chapter we show that formulas of extensions of
% $\FP^{\nats}$ by generalised operators may be translated to a $\PT$-uniform
% family of transparent symmetric circuits over an appropriate basis.



% that the extension of $\FP^{\nats}$ by rank operators that take a prime as a
% parameter define a strictly more expressive logic than the extension by rank
% operators without such a parameter. As such,

% These general operators are intended to inspired by the generalised
% quantifiers of Lindestrom. However,





% As such, $\FP^{\nats}$ can

% We have from the Immerman-Vardi~\cite{} theorem that over linearly ordered
% structures $\FP$ captures polynomial time. But $\FP$ does not capture
% polynomial time over unordered structures as it can not, for example, express
% the $\parity$ query. The contrast between the expressive power over ordered
% and unordered structures motivates the introduction $\FP^{\nats}$.
% $\FP^{\nats}$ extends $\FP$ with a number-sort, allowing the logic to reason
% over the universe of the structure (the element sort) or over a separate
% linearly-ordered number domain (the number sort) with the same cardinality as
% the structure. As such $\FP^{\nats}$ can solve polynomial-time problems over
% it's number domain (and so can express $\parity$), but, importantly, the logic
% has no mechanism for relating the (unordered) domain of the structure with the
% ordered number domain. $\FPC$ extends $\FP^{\nats}$ with a counting operator
% that provide We can understand the many of the logics of interest, including
% $FPC$ and $\FPR$, as extending $\FP^{\nats}$ by operators that provide such a
% mechanism.


% by introducing operators that act on a sequence of formulas and number terms
% and evaluates to an element of the number sort. In the case of $\FPC$ this
% operator acts on a formula and evaluates to the cardinality of the set defined
% by that formula, and in the case of $\FPR$ this operator acts on a number-term
% and evaluates to the rank of the matrix over the appropriate field.

% Importantly, in the case of $\FPC$ we can associate this counting operator
% with

% In the same way Lindstr-om quantifiers provide a general mechanism for
% extending a logic by a quantifier, in this chapter we introduce the notion of
% a \emph{generalised operators} that provide a general mechanism for extending
% a logic by an operator. We show that each generalised operator may be
% assosiated with a family of quantifiers.

% In this chapter we provide a formal notion of a general operator and define
% what it means to extend a logic with such an operator. A general operator
% differs from a general quantifier in that (i) a general operator can evaluate
% to a number-term, (ii) a general operator


% that acts as a mechanism for

% as extenas introducing a mechanism for relating the unordered element domain
% with the ordered number domain. For example, $\FPC$ extends $\FP^{\nats}$ by
% introducing counting operators, operators that act on formulas and evaluate to
% the cardinality of the set define by the formula.

% In this chapter we will introduce a general framework


% an operator that

% that allows one to relate the element domain


% extends $\FP^{\nats}$ by introducing a counting




% `order on the side', allowi to refer to the structure or over a separate
% number domain


% , which extends $\FP$ with the ability to quantify over a second-order


% cases, where $\FP$ has the full power of a polynomial-time bounded Turing
% machine, and the unordered cases, where $\FP$ cannot express seemingly trivial
% queries, motivated the study of logics which introduce an `order on the side'.
% that allow for reasoning both of the structure and over a separate ordered
% number domain.



% In particular, $\FP^{\nats}$ can use the number domain to express
% polynomial-time queries for which membership depends just on the size of the
% structure. However, in $\FP^{\nats}$ there is no mechanism for relating the
% unordered domain of the structure and the associated ordered number-domain.

% Many of the logics that arise in the finite model theory extend $\FP^{\nats}$
% (or $\FO^{\nats}$) with operators that relate the element domain and the
% number domain. For example, $\FPC$ and extends $\FP^{\nats}$ with a counting
% operator that allows one to define defines the cardinality of a set (of either
% domain)





% the ordered and unordered domains. A natural extension of $\FP$ considered in
% the literature is $\FP^{\nats}$to extend the logic



% Instead of requiring an order on the structure $\FP$

% The logic $\FP^{\nats}$ is an extension of $\FP$ that allows references not
% just to the structure but also over a separate linearly ordered number domain.
% This `order on the side' allows us to express in $\FP^{\nats}$ any
% polynomial-time decidable query for which membership depends only on the size
% of the structure (e.g.\ parity).


% We cannot express all polynomial time decidable queries because in
% $\FP^{\nats}$ the domain of the structure and the number domain are treated as
% completely separate, and there is no mechanism for relating these two domains.


% In this extension, using the Immerman-Vardi~\cite{} theorem, allows us to
% express



% In the ordered domain allows us to express in $\FP^{\nats}$ polynomial-time
% decidable query such that membership depends only on the size of the structure
% (including parity).





% This has lead to the study of logics that allow for reasoning over


% This has lead to the study of logics such as $\FP^{\nats}$ which extend $\FP$
% allowing for reasoning over the domain of the structure and over a separate
% ordered number domain. If we could identify the domain of the structure with
% the number domain

% and extensions of $\FP^{\nats}$, e.g.\ $\FPC$ and $\FPR$. These extensions
% introduce operators that relate the domain of the structure with this ordered
% number-domain.


% The natural approach,


% In particular, we are interested in logics that extend $\FP^{\nats}$ with
% operators and quantifiers that allow us to relate the element-sort and
% number-sort

% In such a logic we have access not only to a structure but to an `order on the
% side', and t


% This has lead to study of extesnions logics that allow for reasoning both over
% the domain of the structure and a separate associated linearly-ordered
% number-sort (e.g.\ $\FP^{\nats}$).

% This lead to the study of extensions of $\FP$ with a number sort, allowing one
% to reason either over the domain of the structure (the element-sort) or over
% an ordered domain associated with the structure (the number-sort). In
% particular, we are interested in logics tha


% If we could define in the logic a bijection between these separate sorts, then
% we could order the domain and apply the Immerman-Vardi theorem. Research has
% thus focused on extensions of $\FP$

% Supposing we cou define a bijection between the element and number sort in
% such , then we could define linearly order the structure and the logic would
% capture polynomial-time.

% This has lead to the study of logics with counting (e.g.\ $\FOC$ and $\FPC$).
% These logics do not impose an order on the structure, but do argument the
% structure with an (ordered) number domain.

% In this chapter we introduce a general notion of an operator and show that a
% formula from a fixed-point logics extended with these operators

% \section{Substitution Programs}
% \begin{definition}
%   Let $L$ be a logic and $\tau$ be a vocabulary. For each $i > 0$ let $R_i$ be
%   a distinct relation symbol not in $\tau$ with arity $r_i$. We say a sequence
%   of formulas $\Phi := (\phi_1(\vec{y}_1), \ldots, \phi_k(\vec{y}_k))$ is a
%   \emph{substitution program} on $L$ if for each $i \in [k]$ we have that
%   $\phi_i$ is an $L[\tau_i]$-formula, where $\tau_i = \tau \uplus \{R_j : i <
%   j \leq k\}$, and each $\vec{y}_i$ has length $r_i$.
% \end{definition}


% \input{../figures/test/drawing.pdf_tex}
% \input{../figures/formulas_to_circuits.tex}

\section{Structures with Number-Valued Functions}
\label{chpt:gen-op--sec:num-valued-vocab}
% We aim to define generalised operators using classes of structures and
% interpretations, in a similar way as for {\lindstrom} quantifiers. However,
% while {\lindstrom} quantifiers act on formulas, many operators, e.g.\ rank
% operators, act on sequences of \emph{number terms}. As such,

A generalised quantifier is defined by a class of relational structures. An
application of a quantifier includes as part of its application an
interpretation. A formula given by an application of a quantifier evaluates to
true if, and only if, the structure defined by the interpretation is a member of
the specified class of structures. We aim to define a generalised operator
similarly. However, while quantifiers are restricted to act on formulas, many
operators, e.g.\ rank operators, act on sequences of \emph{number terms}. As
such, we define a generalised operator from a class of (many-sorted) structures
consisting of both relations and number-valued functions. In this section we
generalise the notion of a vocabulary so as to allow for such structures and
correspondingly generalise the notion of an interpretation.


% . In order to similarly associate


% However, unlike quantifiers, many operators, e.g.\ rank operators, act on
% sequences of \emph{number terms}, rather than formulas. In this section


% In this section we generalise the notion of a vocabulary so as to allow for
% structures that and we correspondingly generalise the notion of an
% interpretation. In this section we generalise the notion of an

% As such, in order to develop a general theory of operators we need a more
% general notion of a structure, one that allows for number-valued functions
% (which can then be defined by number-terms). In this section we introduce this
% general notion of a structure


% As such, we define a generalised operator from a class of (many-sorted)
% structures consisting of both relations and number-valued functions.However,
% operators, such as

% The generalised operators we introduce later on this chapter are similarly
% defined by classes of structures, but in this case the structures have
% many-sorts and may include number-valued functions. In this section we
% generalise the notion of a vocabulary so as to allow for such structures and
% we correspondingly generalise the notion of an interpretation.




% quantifier is applied to a sequence of formulas which together define an
% interpretation.

% are defined by classes of relational structures and act on sequences of

% For each relational vocabulary $\rho$ and class of $\rho$-structures
% $\mathcal{C}$ we can define a {\lindstrom} quantifier $Q_{\mathcal{C}}$. An
% application of $Q_{\mathcal{C}}$ in a fo


% We define a {\lindstrom} quantifier $Q_{\mathcal{C}}$ by


% Each {\lindstrom} quantifier is defined by a some class of structures
% $\mathcal{C}$ over some relational vocabulary $\rho$. A {\lindstrom}
% quantifier acts on a sequence of $L[\sigma]$-formulas which together define a
% $L[\sigma, \rho]$-interpretation, and hence determines a $\rho$-structure. A
% formula with the quantifier at its head evaluates to true if, and only if, the
% $\rho$-structure defined is in $\mathcal{C}$ (for details see~\ref{}). In
% contrast with Lindstr\"{o}m quantifiers, generalised operators act on
% sequences of both number terms (as rank operators do) and formulas (as
% counting operators do). As such, we define a generalised operator from a class
% of (many-sorted) structures consisting of both relations and number-valued
% functions. In this section we generalise the notion of a vocabulary so as to
% allow for such structures and we correspondingly generalise the notion of an
% interpretation.

% In order to define a {\lindstrom} quantifier we begin with a class of
% structures $\mathcal{C}$ over some relational vocabulary $\rho$. An
% application of a {\lindstrom} quantifier in some formula acts on a sequence of
% $L[\sigma]$-formulas which together define a $L[\sigma, \rho]$-interpretation,
% and hence determines a $\rho$-structure. A formula with the quantifier at its
% head evaluates to true if, and only if, the $\rho$-structure defined is in
% $\mathcal{C}$ (for details see~\ref{}). In contrast with Lindstr\"{o}m
% quantifiers, generalised operators act on sequences of both number terms (as
% rank operators do) and formulas (as counting operators do). As such, we define
% a generalised operator from a class of (many-sorted) structures consisting of
% both relations and number-valued functions. In this section we generalise the
% notion of a vocabulary so as to allow for such structures and we
% correspondingly generalise the notion of an interpretation.

\begin{definition}
  A \emph{many-sorted vocabulary with number-valued functions} is a tuple $\tau
  := (R, F, S, \zeta)$ where $R$ is a sequence of relation symbols, $F$ is a
  sequence of function symbols, $S$ is a sequence of sort symbols, and $\zeta$
  is a function that assigns each $H \in R \cup F$ of arity $h$ to a tuple of
  sort symbols $(s_1, \ldots, s_h)$.

  We say that $\mathcal{A}$ is a $\tau$-structure if $\mathcal{A} = (\uplus_{s
    \in S} A_s; (R^{\mathcal{A}}_i)_{R_i \in R} ; (F^{\mathcal{A}}_i)_{F_i \in
    F})$ where
  \begin{myitemize}
  \item for each $s \in S$, $A_s$ is a non-empty set,
  \item for each $R_i \in R$, $R^{\mathcal{A}}_i \subseteq A_{\zeta(R_i)(1)}
    \times \ldots \times A_{\zeta(R_i)(\ar(R_i))}$, and
  \item for each $F_i \in R$, $F^{\mathcal{A}}_i : A_{\zeta(R_i)(1)} \times
    \ldots \times A_{\zeta(R_i)(\arity(R_i))} \ra \nats$.
  \end{myitemize}

  Let $\mathcal{A}$ and $\mathcal{B}$ be $\tau$-structures. We call $h : A \ra
  B$ a \emph{homomorphism} if (i) $h$ preserves sorts, (ii) for all $R_i \in R$
  and $a \in R^{\mathcal{A}}_i$ we have $h(a) \in R^{\mathcal{B}}_i$, and (iii)
  for all $F_i \in F$ and $a \in \dom (F^{\mathcal{A}}_i)$ we have
  $F^{\mathcal{A}}_i(a) = F^{\mathcal{B}}_i(h(a))$. If $h$ is a bijection we
  call $h$ an \emph{isomorphism}.
\end{definition}


We now define a many-sorted interpretation with number-valued functions.

\begin{definition}
  Let $L$ be a logic with a number sort. Let $\rho$ be a vocabulary. Let $\tau =
  (R, F, S, \zeta)$ be a many-sorted vocabulary with number-valued functions,
  where $R = \{R_1, \ldots, R_{r}\}$, $F = \{ F_1, \ldots, F_{f} \}$, and $S =
  \{s_1, \ldots, s_{q}\}$. For each $i \in [r]$ and $j \in [f]$ let $r_i$ denote
  the arity of $R_i$ and $f_j$ be the arity of $F_j$.

  Let $k \in \nats$ and let $\ar : S \times [2] \ra \nats$. A \emph{many-sorted
    $L [\rho, \tau]$-interpretation} with \emph{width} $\ar$ and \emph{free
    variables} $\vec{w}$ (of mixed sort) is a sequence $\mathcal{I} :=
  (\vec{\phi}^D, \vec{\phi}^{\approx}, (\phi_i)_{i \in [r]}, (\eta_j)_{j \in
    [f]})$ of $L[\rho]$-formulas such that
  \begin{myenum}
  \item $\vec{\phi}^D = (\phi^D_1, \ldots, \phi^D_q)$, and for each $i \in [q]$,
    $\phi^D_i(\vec{x}, \vec{\mu}; \vec{w})$ where $\vert \vec{x} \vert =
    \ar(s_i, 1)$ and $\vert \vec{\mu} \vert = \ar(s_i, 2)$;
  \item $\vec{\phi}^{\approx} = (\phi^{\approx}_1, \ldots, \phi^{\approx}_q)$,
    and for each $i \in [q]$ $\phi^{\approx}_i(\vec{x}_1\vec{\mu}_1, \vec{x}_2
    \vec{\mu}_2 ; \vec{w})$ where $\vert \vec{x}_1 \vert = \vert \vec{x}_2 \vert
    = \ar(s_i, 1)$ and $\vert \vec{\mu}_1 \vert = \vert \vec{\mu}_2 \vert =
    \ar(s_i, 2)$;
  \item for each $i \in [r]$, $\phi_i (\vec{x}^i_1 \vec{\mu}^i_1, \ldots,
    \vec{x}^{i}_{r_i} \vec{\mu}^{i}_{r_i} ; \vec{w})$ where for each $j \in
    [r_i]$, $\vert \vec{x}^i_j\vert = \ar(\zeta(R_i)(j), 1)$ and $\vert
    \vec{\mu}^i_j \vert = \ar(\zeta(R_i)(j), 2)$; and
  \item for each $i \in [f]$, $\nu_i (\vec{x}^i_1 \vec{\mu}^i_1, \ldots,
    \vec{x}^{i}_{f_i} \vec{\mu}^{i}_{f_i} ; \vec{w})$ where for each $j \in
    [f_i]$, $\vert \vec{x}^i_j \vert = \ar(\zeta(R_i)(j), 1)$ and $\vert
    \vec{\mu}^i_j \vert = \ar(\zeta(R_i)(j), 2)$.
  \end{myenum}

  Let $\mathcal{A} \in \fin{\rho}$ and let $n := \vert \mathcal{A} \vert$. Let
  $\beta$ be an assignment to $\vec{w}$ in $\mathcal{A}$. For each $i \in [q]$
  let $(\phi^D_i)^{(\mathcal{A}, \beta)} := \{ \vec{a}\vec{m} \in A^{\ar(s_i,
    1)} \times \nats^{\ar(s_i, 2)}: \mathcal{A} \models \phi^D_i[\beta \cup
  \alpha^{\vec{a}, \vec{m}}_{\vec{x}, \vec{\mu}}] \}$. We say that $\mathcal{I}
  (\mathcal{A}, \beta)$ is defined if there exists $\mathcal{B} \in \fin{\tau}$
  with universe $B = \uplus_{i \in [q]} B_i$ and a sort-preserving surjection $h
  : \uplus_{i \in [q]} (\phi^D_i)^{(\mathcal{A}, \beta)} \ra \uplus_{i \in [q]}
  B_i$ such that
    
  \begin{myenum}
  \item for each $i \in [q]$ the relation $\approx_i$ on $B_i$ defined such that
    for each $\vec{a}_1\vec{m}_1, \vec{a}_2\vec{m}_2 \in
    (\phi^D_i)^{(\mathcal{A}, \beta)}$ we have $\vec{a}_1\vec{m}_1 \approx_i
    \vec{a}_2\vec{m}_2$ if, and only if, $\mathcal{A} \models
    \phi^{\approx}_i[\beta, \alpha^{\vec{a}_1\vec{m}_1,
      \vec{a}_2\vec{m}_2}_{\vec{x}_1 \vec{\mu}_1, \vec{x}_2 \vec{\mu}_2}]$ is an
    equivalence relation;
  \item let $\approx = \uplus_{i \in [q]}\approx_i$ be an equivalence relation
    on $B$, then for $a , b \in \uplus_{i \in [q]}(\phi^D_i)^{(\mathcal{A},
      \beta)}$ if $a \approx b$ then $h(a) = h(b)$;
  \item for each $i \in [r]$ and $j \in [r_i]$ let $\vec{a}^i_j\vec{m}^i_j \in
    (\phi^D_{\zeta(R_i)(j)})^{(\mathcal{A}, \beta)}$ we have
    \begin{align*}
      (h(\vec{a}^i_1 \vec{m}^i_1) , \ldots , h(\vec{a}^i_{r_i}\vec{m}^i_{r_i}))
      \in R^{\mathcal{B}}_i \iff \mathcal{A} \models \phi_i
      [\beta, \alpha^{\vec{a}_1\vec{m}_1, \ldots, \vec{a}_{r_i} \vec{m}_{r_i}}_{\vec{x}^i_1 \vec{\mu}^i_1 , \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i}}];
    \end{align*}
  \item for each $i \in [f]$ and $j \in [f_i]$ let $\vec{a}^i_j\vec{m}^i_j \in
    (\phi^D_{\zeta(F_i)(j)})^{(\mathcal{A}, \beta)}$ we have
    \begin{align*}
      F^{\mathcal{B}}_i(h(\vec{a}^i_1 \vec{m}^i_1 , \ldots , \vec{a}^i_{r_i}\vec{m}^i_{r_i})) = \eta^{(\mathcal{A}, \gamma)}_j \text{ where }\gamma := \beta \cup \alpha^{\vec{a}_1\vec{m}_1, \ldots,
      \vec{a}_{r_i} \vec{m}_{r_i}}_{\vec{x}^i_1 \vec{\mu}^i_1 , \ldots,
      \vec{x}^i_{r_i} \vec{\mu}^i_{r_i}}.
    \end{align*}
  \end{myenum}

  In this case we write $\mathcal{B} = \mathcal{I} (\mathcal{A}, \beta)$ and say
  that \emph{$\mathcal{I}$ interprets $\mathcal{B}$ in $(\mathcal{A}, \beta)$}
  or \emph{$\mathcal{I}$ interprets $\mathcal{B}$ in $\mathcal{A}$ under
    $\beta$}.
\end{definition}


% \section{A Framework for Operators and Quantifiers}


% Lindestrom quantifiers are defined by a class of structures, with the syntax
% of the quantifier is specified so as to define an interpretation, with the
% quantifier's evaluation depending on whether In the same way Lindestrom
% quantifiers are defined from a class of structures, generalised operators are
% similarly defined from a class of structures.


% We first need to generalise the notion of a many-sorted vocabulary in order to
% include function symbols that are intended to be interpreted as number-valued
% functions.

% \begin{definition}
%   Let $L$ be a logic ($\FO$ or $\FP$) and let $\tau$ be a many-sorted
%   vocabulary with function and constant symbols and $N: \fin \ra \fin[\tau]$
%   be a function that maps isomorphic structures to isomorphic structures. Let
%   $S = \{s_1, \ldots, s_q\}$ be the sorts in $\tau$. Let $\rho$ be a
%   vocabulary. Let $\tau \uplus \rho$ be the vocabulary formed by interpreting
%   $\rho$ as a many-sorted vocabulary with a single sort. We refer to the
%   single sort of $\rho$ as the \emph{element sort}. Let $L^{\tau, N}[\rho] =
%   L[\tau \uplus \rho]$ and for $\theta \in L^{\tau, N}[\rho]$ and $\mathcal{A}
%   \in \fin[\rho]$ let $\mathcal{A} \models_{L^{\tau, N}[\rho]} \theta$ if, and
%   only if, $(\mathcal{A} \uplus N(\mathcal{A})) \models_{L[\tau \uplus \rho]}
%   \theta$.
% \end{definition}

% Let $L^{\tau, N}[\rho]$ be a logic. We say $N$ is \emph{uniform} if for any
% $\mathcal{A}, \mathcal{B} \in \fin$ such that $\vert \mathcal{A} \vert = \vert
% \mathcal{B} \vert$ we have $N(\mathcal{A}) = N(\mathcal{B})$. In this case for
% each $n \in \nats$ we write $N(n)$ to abbreviate $N(\mathcal{A})$ for any
% $\mathcal{A} \in \fin$ of size $n$. We say $N$ is \emph{$\PT$-uniform} if $N$
% is uniform and $n \mapsto N(n)$ is computable in time polynomial in $n$.

% \begin{definition}
%   A \emph{many-sorted vocabulary with number-valued functions} is a tuple
%   $\tau := (R, F, S, \zeta)$ where $R$ is a sequence of relation symbols, $F$
%   is a sequence of function symbols, $S$ is a sequence of sort symbols, and
%   $\zeta$ is a function that assigns each $H \in R \cup F$ of arity $h$ to a
%   tuple of sort symbols $(s_1, \ldots, s_h)$.
% \end{definition}

% There is an obvious notion of a $\tau$-structure and isomorphism between
% $\tau$-structures.

% \begin{definition}
%   Let $L$ be a logic with a number sort. Let $\rho$ be a vocabulary. Let $\tau
%   = (R, F, S, \zeta)$ be a many-sorted vocabulary with number-valued
%   functions, where $R = \{R_1, \ldots, R_{r}\}$, $F = \{ F_1, \ldots, F_{f}
%   \}$, and $S = \{s_1, \ldots, s_{q}\}$. For each $i \in [r]$ and $j \in [f]$
%   let $r_i$ denote the arity of $R_i$ and $f_j$ be the arity of $F_j$.

%   Let $\ar : S \times [2] \ra \nats$. A \emph{many-sorted $L [\rho,
%   \tau]$-interpretation} of \emph{width} $(\ar)$ is a sequence $\mathcal{I} :=
%   (\vec{\phi}^D, \vec{\phi}^{\approx}, (\phi_i)_{i \in [r]}, (\eta_j)_{j \in
%   [f]})$, where

%   \begin{myenum}
%   \item $\vec{\phi}^D = (\phi^D_1, \ldots, \phi^D_q)$, and for each $i \in
%     [q]$, $\phi^D_i(\vec{x}, \vec{\mu})$ where $\vert \vec{x} \vert = \ar(s_i,
%     1)$ and $\vert \vec{\mu} \vert = \ar(s_i, 2)$,
%   \item $\vec{\phi}^{\approx} = (\phi^{\approx}_1, \ldots, \phi^{\approx}_q)$,
%     and for each $i \in [q]$ $\phi^{\approx}_i(\vec{x}_1\vec{\mu}_1, \vec{x}_2
%     \vec{\mu}_2)$ where $\vert \vec{x}_1 \vert = \vert \vec{x}_2 \vert =
%     \ar(s_i, 1)$ and $\vert \vec{\mu}_1 \vert = \vert \vec{\mu}_2 \vert =
%     \ar(s_i, 2)$,
%   \item for each $i \in [r]$, $\phi_i (\vec{x}^i_1 \vec{\mu}^i_1, \ldots,
%     \vec{x}^{i}_{r_i} \vec{\mu}^{i}_{r_i})$ where for each $j \in [r_i]$,
%     $\vert \vec{x}^i_j\vert = \ar(\zeta(R_i)(j), 1)$ and $\vert \vec{\mu}^i_j
%     \vert = \ar(\zeta(R_i)(j), 2)$, and
%   \item for each $i \in [f]$, $\nu_i (\vec{x}^i_1 \vec{\mu}^i_1, \ldots,
%     \vec{x}^{i}_{f_i} \vec{\mu}^{i}_{f_i})$ where for each $j \in [f_i]$,
%     $\vert \vec{x}^i_j \vert = \ar(\zeta(R_i)(j), 1)$ and $\vert \vec{\mu}^i_j
%     \vert = \ar(\zeta(R_i)(j), 2)$.
%   \end{myenum}

%   Let $\mathcal{A} \in \fin[\rho]$ and for all $i \in [q]$ let
%   $(\phi^D_i)^{\mathcal{A}} := \{ \vec{a}\vec{m} \in A^{\ar(s_i, 1)} \times
%   \nats^{\ar(s_i, 2)}: \mathcal{A} \models \phi^D_i[\vec{a}\vec{m}] \}$. We
%   say that $\mathcal{I} (\mathcal{A})$ is defined if there exists $\mathcal{B}
%   \in \fin[\tau]$ with universe $B = \uplus_{i \in [q]} B_i$ and a sort
%   preserving surjection $h : \uplus_{i \in [q]} (\phi^D_i)^{\mathcal{A}} \ra
%   \uplus_{i \in [q]} B_i$ such that:
    
%   \begin{myenum}
%   \item for each $i \in [q]$ the relation $\approx_i$ on $B_i$ defined for
%     each $\vec{a}_1\vec{m}_1, \vec{a}_2\vec{m}_2 \in (\phi^D_i)^{\mathcal{A}}$
%     such that $\vec{a}_1\vec{m}_1 \approx_i \vec{a}_2\vec{m}_2$ if, and only
%     if, $\mathcal{A} \models \phi^{\approx}_i[\vec{a}_1\vec{m}_1,
%     \vec{a}_2\vec{m}_2]$ is an equivalence relation,
%   \item let $\approx = \uplus_{i \in [q]}\approx_i$ be an equivalence relation
%     $B$, then for $a , b \in \uplus_{i \in [q]}(\phi^D_i)^{\mathcal{A}}$ if $a
%     \approx b$ then $h(a) = h(b)$,
%   \item for each $i \in [r]$ and for all $j \in [r_i]$ and
%     $\vec{a}^j_i\vec{m}^j_i \in (\phi^D_i)$ $\vec{a}$$h(a) \in R^h_i =
%     \{(\vec{a}_1\vec{})\}$
%   \end{myenum}
% \end{definition}

\section{Generalised Operators}
\label{chpt:gen-op--sec:generalised-operators}
In this section we define a generalised operator and define what it means to
extend a logic by a generalised operator. We also introduce some notation for
these operators, define different types of extensions by generalised operators,
discuss different classes of generalised operators, and prove a normal form for
generalised operators.

Let $\tau = (R, F, S, \zeta)$ be a many-sorted vocabulary with number-valued
functions, where $R = \{R_1, \ldots, R_{r}\}$, $F = \{ F_1, \ldots, F_{f} \}$,
and $S = \{s_1, \ldots, s_{q}\}$. For each $i \in [r]$ and $j \in [f]$ let $r_i$
denote the arity of $R_i$ and $f_j$ be the arity of $F_j$.

Let $m \in \nats$ and let $E : \nats^{m} \times \fin{\tau} \ra \nats$. We say
that $E$ is \emph{closed under isomorphism} if for all $\mathcal{A}, \mathcal{B}
\in \fin{\tau}$, $\vec{p} \in \nats^{m}$ if $\mathcal{A} \simeq \mathcal{B}$
then $E(\vec{p}, \mathcal{A}) = E(\vec{p}, \mathcal{B})$. Let $\ar : S \times
[2] \ra \nats$ be a function. We associate with the pair $(E, \ar)$ a
\emph{number-valued generalised operator} $\Omega_{(E, \ar)}$. We say the
\emph{vocabulary} of the operator is $\tau$, the \emph{arity} is $\ar$, the
\emph{evaluation function} is $E$, and the \emph{parameter-width} is $m$.

For a logic $L$ the extension $L(\Omega_{E, \ar})$ is the closure of the set of
formulae in $L$ over the following formula formation rule:


Let $\vec{w}$ be mixed-sort sequence of variables. Let $\vec{\pi}$ be a sequence
of number terms in $L(\Omega_{E, \ar})$ with free variables among $\vec{w}$. Let
$\mathcal{I} := (\vec{\phi}^D, \vec{\phi}^{\approx}, (\phi_i)_{i \in [r]},
(\eta_j)_{j \in [f]})$ be an interpretation with formulas and number-terms from
$L(\Omega_{E, \ar})$ with width $\ar$ and free variables among $\vec{w}$. The
following is a number-term
\begin{align*}
  \gamma (\vec{w}) = \Omega_{E, \ar} [\vec{\pi}] [\vec{\phi}^D, \vec{\phi}^{\approx}]  [((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\chi_i))_{i \in [r]}((\vec{y}^j_1 \vec{\nu}^j_1, \ldots, \vec{y}^j_{f_j} \vec{\nu}^j_{f_j})(\eta_j))_{j \in [f]}].
\end{align*}
Let $\mathcal{A}$ be a structure and $\beta$ be an assignment to $\vec{w}$ in
$\mathcal{A}$. Let $\vec{p} = (\pi^{(\mathcal{A}, \beta)}_1, \ldots,
\pi^{(\mathcal{A}, \beta)}_m)$. If $\mathcal{I}(\mathcal{A}, \beta)$ is not
defined let $\gamma^{(\mathcal{A}, \beta)} := 0$ and otherwise let $\mathcal{B}
:= \mathcal{I}(\mathcal{A}, \beta)$ and let $\gamma^{(\mathcal{A}, \beta)} := E
(\vec{p}, \mathcal{B})$.

We can analogously define a \emph{Boolean generalised operator}. The definition
is similar, but in the Boolean case the evaluation function is of the form $E :
\nats^{m} \times \fin{\tau} \ra \{0,1\}$. The extension of a logic by a Boolean
operator is defined similarly, except that an application of an operator defines
a formula rather than a number-term.

We usually denote a set of generalised operators by $\setop$. We write
$\setop_E$ to denote the set of all operators with evaluation function $E$.


% We have $\gamma^{(\mathcal{A}, \beta)}$ if, and only if, $\mathcal{B} =
% \mathcal{I}(\mathcal{A}, \beta)$ and $E$






% $\ar$ $mathcal{I} = $ $\vec{\phi}^D$ and $\vec{\phi}^{\approx}$ be sequences
% of formulas in $L(\Omega_{E, \ar})$ and for each $i \in [r]$ and $j \in [f]$
% let $\chi_i$ be a formula and $\eta_j$ a number-term in $L(\Omega_{E, \ar})$.
% Let



% Let $\vec{\pi}$ be a sequence of number terms in $L(\Omega_{E, \ar})$. Let
% $\vec{\phi}^D$ and $\vec{\phi}^{\approx}$ be the $q$-sequences of formulas
% such that for each $i \in [q]$, $\phi^D_i$ has exactly $\ar(s_i, 1)$ free
% element ,ariables and $\ar(s_i, 2)$ free number variables and
% $\phi^{\approx}_i$ has exactly $2\cdot\ar(s_i, 1)$ free element variables and
% $2\cdot\ar(s_i, 2)$ free number variables. Let $(\chi_i)_{i \in [r]}$ and
% $(\eta_i)_{i \in [f]}$ be sequences of formulas and number-terms,
% respectively. For each $i \in [r]$ and $l \in [r_i]$ let $s = \zeta (R_i)(l)$
% and let $\vec{x}^i_l$ be an $\ar(s, 1)$-length tuple of element variables and
% $\vec{\mu}^i_l$ be an $\ar(s, 2)$-length tuple of number variables. For each
% $j \in [f]$ and $k \in [f_j]$ let $s = \zeta (F_i)(k)$ and let $\vec{y}^j_k$
% be an $\ar(s, 1)$-length tuple of element variables and $\vec{\nu}^j_k$ be an
% $\ar(s, 2)$-length tuple of number variables. The following is a number term:
% \begin{align*}
%   \gamma = \Omega_{E, \ar} [\vec{\pi}] [\vec{\phi}^D, \vec{\phi}^{\approx}]  [((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\chi_i))_{i \in [r]}((\vec{y}^j_1 \vec{\nu}^j_1, \ldots, \vec{y}^j_{f_j} \vec{\nu}^j_{f_j})(\eta_j))_{j \in [f]}].
% \end{align*}
% The semantics of this operator is defined as follows: Let $\mathcal{I} :=
% (\vec{\phi}^D, \vec{\phi}^{\approx}, \vec{\chi}, \vec{\eta})$ and
% $\gamma^{\mathcal{A}} = E(\vec{\pi}^{\mathcal{A}}, \mathcal{I}(\mathcal{A}))$.


Let $\setop$ be a set of operators and $\rho$ be a relational vocabulary. Let
$L(\widetilde{\setop})[\rho]$ be the set of all formulas and number-terms in
$L(\setop)[\rho]$ such that each application of a generalised operator in
$\setop$ that appears as a sub-formula or sub-number-term has domain formulas
that are valid and equality formulas that simply test for equality. In other
words, each application of an operator defines an interpretation that involves
no restriction of the domain and no quotienting. In this case, since the domain
and equality formulas have no effect on the semantics, we omit them when
applying the generalised operator.

\begin{definition}
  Let $\setop$ be a set of operators. We say a logic $L(\setop)$ is \emph{closed
    under $\setop$-quotients} if for any relational vocabulary $\rho$ we have
  $L(\widetilde{\setop})[\rho] = L(\setop)[\rho]$. If the set of operators
  $\setop$ is clear from context we say that $L(\setop)$ is \emph{closed under
    operator quotients}.
\end{definition}

It can be shown that many of the logics of interest are closed under operator
quotients (see~\ref{}).

\begin{lem}
  The logics $\FPC$ and $\FPR$ are closed under operator quotients.
  \label{lem:logics-operator-quotients}
\end{lem}

We are often interested in families of operators generated by a single
evaluation function. Let $E$ be an evaluation function. Let $\setop_E$ denote
the set of all operators $\Omega_{E, \ar}$ where $\ar$ is an arbitrary arity
function. We call $\setop_E$ the \emph{uniform operator} generated by $E$. When
we apply an operator in a formula the arity is implicitly specified by the
choice of variables. As such, when applying an operator $\Omega_{E, \ar}$ from
$\setop_E$ we often use the symbol of the uniform operator rather than the
particular operator.

We have not included any sort of bound on the functions computed by generalised
operator. We are particularly interested in logics whose formulas cannot define
numbers that are super-polynomial in the size of the structure over which they
are being evaluated. In this case each number-term denotes a value that be held
by a fixed-length tuple of number variables.

\begin{definition}
  Let $L$ be a logic with a number sort. Let $\rho$ be a vocabulary. Let
  $\theta$ be a formula or number-term in $L[\rho]$. For each $n \in \nats$ let
  $e_{\theta}(n) $ be the maximal value of $\max\{\gamma^{(\mathcal{A}, \alpha)}
  : \mathcal{A} \in \fin{\mathcal{A}, n} , \,\, \alpha \in
  \asgn{\gamma}{\mathcal{A}}\}$ for any number-term $\gamma$ that appears in
  $\theta$. We call the function $e_{\theta}$ the \emph{definable-number bound}
  of $\theta$. We say $\theta$ has \emph{constant definable-number width} if
  there exists $k \in \nats$ such that for all $n \in \nats$ we have
  $e_{\theta}(n) \leq (n+1)^k - 1$. We call $k$ the \emph{definable-number
    width} of $\theta$. We say the logic $L$ has \emph{constant definable-number
    width} if for any vocabulary $\rho$ each formula in $L[\rho]$ has constant
  definable-number width.
\end{definition}

It can be shown that many commonly used logics with number-sorts have constant
definable-number width.

\begin{lem}
  The logics $\FO^{\nats}$, $\FP^{\nats}$, $\FPC$, and $\FPR$ have constant
  definable-number width.
  \label{lem:logics-constant-number-width}
\end{lem}

In many applications we only need to consider a restricted class of generalised
operators. We now introduce a few difference classes of generalised operators.

\begin{definition}
  Let $\Omega$ be a generalised operator. We say $\Omega$ \emph{operates on
    formulas} if there are no function symbols in the vocabulary of $\Omega$. We
  say that $\Omega$ \emph{has no parameters} if the parameter-width is zero. We
  say $\Omega$ \emph{operates over the structure} if it operates on formulas and
  $\Omega$ has arity $\ar$ and for each sort symbol $s$ in the vocabulary of
  $\Omega$, $\ar(s, 2) = 0$. We say $\Omega$ is \emph{single sorted} if the
  vocabulary of $\Omega$ is single sorted.
\end{definition}

We now show that if we extend a logic with generalised operators with constant
definable-number width then we may assume, without a loss of generality, that
the generalised operators operate on formulas.

\begin{prop}
  Let $\tau := (R, F, S, \zeta)$ be a many-sorted vocabulary with number-valued
  functions. Let $E : \nats^m \times \fin{\tau} \ra \nats$ be an evaluation
  function. Let $L$ be an extension of $\FO^{\nats}$ and suppose $L(\setop_E)$
  has constant numeric-width. There is a many-sorted vocabulary $\tau' = (R',
  S', \zeta')$ and evaluation function $E' : \nats^m \times \fin{\tau} \ra
  \nats$ such that
  \begin{myenum}
    % \item \label{obj:const-width}$L(\setop_{E'})$ has constant numeric-width,
  \item \label{obj:left-right} $L(\setop_{E}) \leq L(\setop_{E'})$, and
  \item \label{obj:FOC-right-left} if $\FOC \leq L$ then $L(\setop_{E'}) \leq
    L(\setop_{E})$.
    % \item \label{obj:FP-right-left} if $\FP^{\nats} \leq L$ then
    %   $L(\setop_{E'})
    %   \leq L(\setop_E)$.
  \end{myenum}
  It follows that if $\FOC \leq L$ then $L(\setop_{E}) \equiv L(\setop_{E'})$.
  \label{prop:operators-to-onformulas}
\end{prop}
\begin{proof}
  Let $\{R_1, \ldots, R_{r}\} := R$, $\{ F_1, \ldots, F_{f} \} := F$, and
  $\{s_1, \ldots, s_{q}\} := S$. For each $i \in [r]$ and $j \in [f]$ let $r_i$
  be the arity of $R_i$ and $f_j$ be the arity of $F_j$. Let $\tau' := (R', S',
  \zeta')$ where
  \begin{myitemize}
  \item $R' = R \uplus \{R_{r + 1}, \ldots, R_{r + f}\}$,
  \item $S' = S \uplus \{s_{q+1}\}$, and
  \item for all $R_i \in R'$ if $i \leq r$ then $\zeta' (R_i) = \zeta(R_i)$,
    otherwise let $\zeta'(R_{i}) = (s_{i, 1}, \ldots, s_{i, f_{i - r}}, s_{i,
      f_{i - r} + 1})$, where $(s_{i, 1}, \ldots, s_{i, f_{i -r}}) = \zeta(F_{i
      - r})$ and $s_{i, f_{i - r}+1} = s_{q+1}$.
  \end{myitemize}
  Let $r' = r + f$ and for all $i \in [r']$ let $r_i$ be the arity of $R_i$. Let
  $T : \fin{\tau'} \ra \fin{\tau}$ be defined such that for each $\mathcal{B}'
  \in \fin{\tau'}$ with universe $B' = \uplus_{i \in [q + 1]}B_i'$ we have that
  \begin{myitemize}
  \item $T(\mathcal{B}')$ has universe $\uplus_{i \in [q]}B_i'$,
  \item for all $R_i \in R$, $R^{T(\mathcal{B}')}_i = R^{\mathcal{B}'}_i$, and
  \item for all $F_j \in F$, $F^{T(\mathcal{B}')}_j(b_1, \ldots, b_{f_j}) =
    \vert \{ b \in B_{q+1}': (b_1, \ldots, b_{f_j}, b) \in R^{\mathcal{B}'}_{r +
      j}\} \vert$.
  \end{myitemize}
  Let $E': \nats^m \times \fin{\tau'} \ra \nats$ be defined such that
  $E'(\vec{p}, \mathcal{B}') = E(\vec{p}, T(\mathcal{B}'))$ for all $(\vec{p},
  \mathcal{B}') \in \nats^m \times \fin{\tau'}$.

  % Let $k \in \nats$. Let $T' : \fin[\tau] \ra \fin[\tau']$ be defined such
  % that
  % for each $\mathcal{B} \in \fin[\tau]$ with universe $B = \uplus_{i \in [q +
  % 1]}B_i$ we have that
  % \begin{myitemize}
  % \item $T'(\mathcal{B})$ has universe $(\uplus_{i \in [q]}B_i) \uplus
  %   B_{q+1}$,
  %   where $B_{q+1} = [(n + 1)^t - 1]$,
  % \item for all $R_i \in R'$, $R^{T'(\mathcal{B})}_i = R^{\mathcal{B}}_i$, and
  % \item for all $F_j \in F$, $F^{\mathcal{B)}}_j(b_1, \ldots, b_{f_j}) = \vert
  %   \{ b \in B_{q+1}': (b_1, \ldots, b_{f_j}, b) \in R^{T'(\mathcal{B})}_{r +
  %   j}\} \vert$.
  % \end{myitemize}

  % Let $\mathcal{B} \in \fin[\tau]$. For each $F_j \in F$ we have
  % $F^{T(T'(\mathcal{B}))}(b_1, \ldots, b_{f_j} = \vert \{ b \in B_{q+1}':
  % (b_1,
  % \ldots, b_{f_j}, b) \in R^{T'(\mathcal{B})}_{r + j}\} \vert =
  % F^{\mathcal{B}}_j(b_1, \ldots, b_{f_j})$. It follows that
  % $T(T'(\mathcal{B}))
  % = \mathcal{B}$. We also have that $R_i \in R'$, if $i \in [r]$ then
  % $R^{T(T'(\mathcal{B}))}_i = R^{T'(\mathcal{B})}_i = R^{\mathcal{B}}_i$ and
  % if
  % $i \not\in [r]$ then $R^{T(T'(\mathcal{B}))}_i = $

  % For each $R \in R'$ we have $F^{T'(t)}$

  We now prove statement~\ref{obj:left-right}. Let $\gamma$ be a number-term or
  formula of $L(\setop_{E})$. We show that there is a corresponding number-term
  or formula $\gamma' \in L(\setop_{E'})$ that translates $\gamma$ by induction
  on the structure of $\gamma$. The only interesting case is the application of
  an operator. Suppose
  \begin{align*} \gamma = \Omega_{E, \ar} [\vec{\pi}] [\vec{\phi}^D,
    \vec{\phi}^{\approx}] [((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i}
    \vec{\mu}^i_{r_i})(\phi_i))_{i \in [r]}((\vec{y}^j_1 \vec{\nu}^j_1, \ldots,
    \vec{y}^j_{f_j} \vec{\nu}^j_{f_j})(\eta_j))_{j \in [f]}],
  \end{align*}
  where $\ar : S \times [2] \ra \nats$ is the arity, $\vec{\pi} = (\pi_1,
  \ldots, \pi_m)$ is a sequence of number-terms, and $(\vec{\phi}^D,
  \vec{\phi}^{\approx}, (\phi_i)_{i \in [r]}, (\eta_j)_{j \in [f]})$ defines an
  $L(\setop_E)[\rho, \tau]$-interpretation. Let $\vec{w}$ be the free variables
  in $\gamma$ and let $t$ be the numeric-term width. From the inductive
  hypothesis there is a translation for each sub-formula and sub-number-term of
  $\gamma$. Let
  \begin{align*}
    \gamma' = \Omega_{E', \ar'}[\vec{\epsilon}\,][\vec{\psi}^D, \vec{\psi}^{\approx}] ((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\psi_i))_{i \in [r']},
  \end{align*}
  where
  \begin{myitemize}
  \item $\ar' : S' \times [2] \ra \nats$ be defined such that $\ar'(s, i) =
    \ar(s,i)$ for all $(s, i) \in S \times [2]$, $\ar'(s_{q+1}, 1) = 0$ and
    $\ar(s_{q+1}, 2) = t$;
  \item $\vec{\epsilon} = (\epsilon_1, \ldots, \epsilon_m)$, where for each $j
    \in [m]$, $\epsilon_j$ is the translation of $\pi_j$;
  \item $\vec{\psi}^D = (\psi^D_1, \ldots, \psi^D_{q}, \psi^D_{q+1})$, where for
    each $i \in [q]$, $\psi^D_i$ is the translation of $\phi^D_i$ and
    $\psi^D_{q+1}$ is a valid formula;
  \item $\vec{\psi}^{\approx} = (\psi^{\approx}_1, \ldots, \psi^{\approx}_q,
    \psi^{\approx}_{q+1})$, where for all $i \in [q]$, $\psi^{\approx}_i$ is the
    translation of $\phi^D_i$ and $\psi^{\approx}_{q+1}(\vec{\nu}_1,
    \vec{\nu}_2) = (\vec{\nu}_1 = \vec{\nu}_2)$; and
    % \item for each $i \in [r']$, and $j \in [r_i]$, $\vec{x}^i_j$ is an
    %   $\ar'(\zeta'(R_i)(j), 1)$-sequence of element variables $\vec{\mu}^i_j$
    %   is a
    %   $\ar'(\zeta'(R_i)(j), 2)$-sequence of number variables, and
  \item for each $i \in [r']$ if $i \leq r$ then $\psi_i$ is the translation of
    $\phi_i$, otherwise let $\eta_{i - r}'$ be the translation of $\eta_{i - r}$
    and let $\psi_i = ((\sum_{l \in [\vert \vec{\mu}^i_{r_i} \vert]}
    \vec{\mu}^i_{r_{i}}(l)(n+1)^{l-1}) < \eta_{i-r}')$.
  \end{myitemize}

  Let $\mathcal{A} \in \fin{\rho}$ and let $\beta$ be an assignment to $\vec{w}$
  in $\mathcal{A}$. Let $n = \vert \mathcal{A} \vert$. Let $\mathcal{I} :=
  (\vec{\phi}^D, \vec{\phi}^{\approx}, (\phi_i)_{i \in [r]}, (\eta_j)_{j \in
    [f]})$ be the $L(\Omega_{E, \ar})[\rho, \tau]$-interpretation defined in
  $\gamma$ and let $\mathcal{I}' := (\vec{\psi}^D, \vec{\psi}^{\approx},
  (\psi_i)_{i \in [r']})$ be the corresponding $L(\Omega_{E', \ar'})[\rho,
  \tau']$-interpretation defined in $\gamma'$. We now prove $\gamma'$ translates
  $\gamma$ using the following two claims.

  % We
  % $\mathcal{I}(\mathcal{A}, \beta)$ is defined if, and only if,
  % $\mathcal{I}'(\mathcal{A}, \beta)$ is defined, and, second, if
  % $\mathcal{I}(\mathcal{A}, \beta)$ is defined then $\mathcal{I}(\mathcal{A},
  % \beta) = T(\mathcal{I}'(\mathcal{A}, \beta))$.

  \begin{claim}
    If $\mathcal{B} = \mathcal{I}(\mathcal{A}, \beta)$ then
    $\mathcal{I}'(\mathcal{A}, \beta)$ is defined and $\mathcal{B} =
    T(\mathcal{I}'(\mathcal{A}, \beta))$.
    \label{claim:not-to-dash}
  \end{claim}
  \begin{proof}
    Let $h$ be the coordinate map that witnesses $\mathcal{B} =
    \mathcal{I}(\mathcal{A}, \beta)$. Let $B = \uplus_{i \in [q]} B_i$ be the
    universe of $\mathcal{B}$. Let $\mathcal{B}'$ be the $\tau'$-structure with
    universe $B' = (\uplus_{i \in [q]} B_i) \uplus B_{q + 1}$, where $B_{q+1} =
    [(n+1)^t - 1]_0$, and such that for each $i \in [r']$ if $i \leq r$ then
    $R^{\mathcal{B}'}_i = R^{\mathcal{B}}_i$, otherwise $R^{\mathcal{B}'}_i =
    \{(a_1, \ldots, a_{f_{i - r}}, a_{r_i}) : a_{r_i} < F^{\mathcal{B}}_{i -
      r}(a_1, \ldots, a_{f_{i - r}}) \}$. Let $h' : \uplus_{i \in [q+1]}
    (\psi^D_i)^{(\mathcal{B}', \beta)} \ra \mathcal{B}'$ be defined such that
    for each $\vec{b} \in \uplus_{i \in [q+1]} (\psi^D_i)^{(\mathcal{B}',
      \beta)}$ if $\vec{b} \in B$ then $h'(\vec{b}) = h(\vec{b})$, otherwise
    $\vec{b} \in (\psi^D_{q+1})^{(\mathcal{B}', \beta)} = \numdompow{n}{t}$ we
    have that $h'(a) = \sum_{i \in [\vert \vec{b} \vert]} b_i (n+1)^{i-1}$.

    It follows that $h'$ is sort-preserving and surjective. We now show that
    $\mathcal{B}' = \mathcal{I}'(\mathcal{A}, \beta)$ with coordinate map $h'$.
    Let $i \in [q+1]$ and let $\approx_i'$ be the relation defined by evaluating
    $\psi^{\approx}_i$ on $\mathcal{B}'$ with assignment $\beta$. If $i = q + 1
    $ then $\psi^\approx_i$ defines equality between the two tuples and hence
    $\approx_i'$ is an equivalence relation. Otherwise, $i \leq q$ and so
    $\approx_i = \approx_i'$. It follows that each $\approx_i'$, and hence
    $\approx' := \uplus_{i \in [q+1]} \approx_i'$, are equivalence relations.
    Let $\vec{a}, \vec{b} \in \uplus_{i \in [q + 1]}(\psi^D_i)^{(\mathcal{A},
      \beta)}$ if $h'(\vec{a}) = h'(\vec{b})$ then there exists $i \in [q + 1]$
    such that $\vec{a}, \vec{b} \in (\psi^D_i)^{(\mathcal{A}', \beta)}$. Suppose
    $\vec{a} \approx_i' \vec{b}$. If $i = q + 1$ then, since $\vec{a} \approx_i'
    \vec{b}$ implies $\vec{a} = \vec{b}$, we have $h'(\vec{a}) = h'(\vec{b})$.
    Otherwise, $i \leq q$ and so, since $\vec{a} \approx_i' \vec{b}$ implies
    $\vec{a} \approx_i \vec{b}$, we have $h'(\vec{a}) = h(\vec{a}) = h(\vec{b})
    = h'(\vec{b})$.

    It remains to show that $\approx_i'$ is a congruence. Let $i \in [r']$. If
    $i \leq r$ then this follows trivially. Suppose $i > r$. For each $j \in
    [r_i]$ let $k \in [q + 1]$ such that $s_{k} = \zeta(R_i)(j)$ and let
    $\vec{a}^i_j\vec{m}^i_j \in (\phi^D_{k})^{(\mathcal{A}, \beta)}$. It follows
    that $r_i = f_{i - r} + 1$ and $\ar'(\zeta'(R_i)(r_i), 1) = 0$ and so
    \begin{align*}\setlength{\jot}{3ex}
      ((h'(\vec{a}^i_1 \vec{m}^i_1) , \ldots , h'(\vec{a}^i_{r_i}\vec{m}^i_{r_i})) \in
      R^{\mathcal{B}'}_i & \iff (h(\vec{a}^i_1 \vec{m}^i_1) , \ldots , h(\vec{a}^i_{f_{i - r}}\vec{m}^i_{f_{i - r}}), h'(\vec{m}^i_{r_i})) \in
                           R^{\mathcal{B}'}_i \\[11pt]
                         & \iff F^{\mathcal{B}}_{i - r}(h(\vec{a}^i_1 \vec{m}^i_1) , \ldots,
                           h(\vec{a}^i_{f_{i - r}}\vec{m}^i_{f_{i - r}})) >  h'(\vec{m}^i_{r_i}) = \sum_{l \in [t]} \vec{m}^i_{r_{i}}(l)(n+1)^{l-1} \\
                         & \iff  (\eta_{i - r})^{(\mathcal{A}, \gamma)} > \sum_{l \in [t]}
                           \vec{m}^i_{r_{i}}(l)(n+1)^{l-1} \text{ where } \gamma = \beta \cup \alpha^{\vec{a}_1\vec{m}_1, \ldots,
                           \vec{a}_{f_{i - r}} \vec{m}_{f_{i -r}}, \vec{m}_{r_i}}_{\vec{x}^i_1 \vec{\mu}^i_1 , \ldots,
                           \vec{x}^i_{f_{i - r}} \vec{\mu}^i_{f_{i - r}}, \vec{\mu}^i_{r_i}} \\
                         & \iff \mathcal{A} \models \psi_i [\beta, \gamma] \text{ where } \gamma = \alpha^{\vec{a}_1\vec{m}_1, \ldots,
                           \vec{a}_{f_{i - r}} \vec{m}_{f_{i -r}}, \vec{m}_{r_i}}_{\vec{x}^i_1 \vec{\mu}^i_1 , \ldots,
                           \vec{x}^i_{f_{i - r}} \vec{\mu}^i_{f_{i - r}}, \vec{\mu}^i_{r_i}}.
    \end{align*}

    % \begin{align*}
    %   h'(\vec{a}^i_1 \vec{m}^i_1 , \ldots , \vec{a}^i_{r_i}\vec{m}^i_{r_i}) \in
    %   R^{\mathcal{B}'}_i & \iff (h'(\vec{a}^i_1 \vec{m}^i_1) , \ldots
    %                        , h'(\vec{a}^i_{r_i -1}\vec{m}^i_{r_i - 1}), h'(\vec{m}^i_{r_i})) \in R^{\mathcal{B}'}_i \\
    %                      & \iff (h(\vec{a}^i_1 \vec{m}^i_1) , \ldots ,
    %                        h(\vec{a}^i_{f_{i -r}}\vec{m}^i_{f_{i-r}}), \sum_{l \in [t]}
    %                        \vec{m}^i_{r_i - 1}(l)(n+1)^{i-1}) \in R^{\mathcal{B}'}_i \\
    %                      & \iff F_{i - r}(h(\vec{a}^i_1 \vec{m}^i_1) , \ldots ,
    %                        h(\vec{a}^i_{r_{i} -1}\vec{m}^i_{r_{i} - 1})) = \sum_{l \in [t]}
    %                        \vec{m}^i_{r_{i}}(l)(n+1)^{l-1} \\
    %                      & \iff  (\eta_{i - r})^{(\mathcal{A}, \gamma)} = \sum_{l \in [t]}
    %                        \vec{m}^i_{r_{i}}(l)(n+1)^{l-1} \text{ where } \gamma = \beta \cup \alpha^{\vec{a}_1\vec{m}_1, \ldots,
    %                        \vec{a}_{f_{i - r}} \vec{m}_{f_{i -r}}, \vec{m}_{r_i}}_{\vec{x}^i_1 \vec{\mu}^i_1 , \ldots,
    %                        \vec{x}^i_{f_{i - r}} \vec{\mu}^i_{f_{i - r}}, \vec{\mu}^i_{r_i}} \\
    %                      & \iff \mathcal{A} \models \psi_i [\beta, \gamma] \text{ where } \gamma = \beta \cup \alpha^{\vec{a}_1\vec{m}_1, \ldots,
    %                        \vec{a}_{f_{i - r}} \vec{m}_{f_{i -r}}, \vec{m}_{r_i}}_{\vec{x}^i_1 \vec{\mu}^i_1 , \ldots,
    %                        \vec{x}^i_{f_{i - r}} \vec{\mu}^i_{f_{i - r}}, \vec{\mu}^i_{r_i}}.
    % \end{align*}

    It follows that $\mathcal{B}' = \mathcal{I}'(\mathcal{A}, \beta)$. It
    remains to show that $\mathcal{B} = T(\mathcal{B}')$, but this follows from
    the following three observations
    \begin{myitemize}
    \item $\uplus_{i \in [q]} B_i$ is the universe of both $\mathcal{B}$ and
      $T(\mathcal{B}')$;
    \item for each $R_i \in R$, $R^{\mathcal{B}}_i = R^{\mathcal{B}'}_i =
      R^{T(\mathcal{B}')}_i$; and
    \item for each $F_i \in F$, $(b_1, \ldots, b_{i}) \in \dom
      (F^{\mathcal{B}}_{i - r})$, and $b \in B_{q+1}$ we have
      $F^{\mathcal{B}}_i(b_1, \ldots, b_{f_i}) > b$ if, and only if, $(b_1,
      \ldots, b_{f_{i}}, b) \in R^{\mathcal{B}'}_{i + r}$, and so
      $F^{\mathcal{B}}_i(b_1, \ldots, b_{f_i}) = \{(b \in B_{q+ 1} : (b_1,
      \ldots, b_{f_{i}}, b) \in R^{\mathcal{B}'}_{i + r}\} =
      F^{T(\mathcal{B}')}_i(b_1, \ldots, b_{f_i})$.
    \end{myitemize}
  \end{proof}
  
  \begin{claim}
    If $\mathcal{I}'(\mathcal{A}, \beta)$ is defined then
    $\mathcal{I}(\mathcal{A}, \beta)$ is defined.
    \label{claim:dash-to-not}
  \end{claim}
  \begin{proof}
    Let $\mathcal{B}' := \mathcal{I}'(\mathcal{A}, \beta)$ with coordinate map
    $h'$ and universe $B' = \uplus_{i \in [q + 1]} B_i$. Let $\mathcal{B}$ be
    the $\tau$-structure with universe $B = \uplus_{i \in [q]}B_i$ and such that
    for each $R_i \in R$ we have $R^{\mathcal{B}}_i = R^{\mathcal{B}'}_i$ and
    for each $F_i \in F$ we have $F^{\mathcal{B}} (b_1, \ldots, b_{f_i}) = \vert
    \{b \in B_{r_{r + i}} : (b_1, \ldots, b_{f_i}, b) \in R^{\mathcal{B}'}_{r +
      i}\} \vert$. Let $h$ be the restriction of $h'$ to $\uplus_{i \in [q]}
    (\psi^D_i)^{(\mathcal{B}', \beta)}$. It remains to show that $\mathcal{B} =
    \mathcal{I}(\mathcal{A}, \beta)$ with coordinate map $h$. This follows from
    a very similar argument as in Claim~\ref{claim:not-to-dash}.
  \end{proof}


  % From Claims~\ref{} and~\ref{} it follows that $\mathcal{I}'(\mathcal{A},
  % \beta)$ is defined if, and only if, $\mathcal{I}(\mathcal{A}, \beta)$ is
  % defined, and if $\mathcal{I}'(\mathcal{A}, \beta)$ is defined then
  % $\mathcal{I}(\mathcal{A}, \beta) = T(\mathcal{I}'(\mathcal{A}, \beta))$.

  Suppose $\mathcal{I}(\mathcal{A}, \beta)$ is not defined. Then, from
  Claim~\ref{claim:dash-to-not}, $\mathcal{I}'(\mathcal{A}, \beta)$ is not
  defined and so $\gamma^{(\mathcal{A}, \beta)} = 0 = (\gamma')^{(\mathcal{A},
    \beta)}$. Otherwise, $\mathcal{I}(\mathcal{A}, \beta)$ is defined and so,
  from Claim~\ref{claim:not-to-dash}, $\mathcal{I}'(\mathcal{A}, \beta)$ is
  defined and $\mathcal{I}(\mathcal{A}, \beta) = T(\mathcal{I}'(\mathcal{A},
  \beta))$. Then $(\gamma')^{(\mathcal{A}, \beta)} =
  E'(\vec{\epsilon}^{(\mathcal{A}, \beta)}, \mathcal{I}'(\mathcal{A}, \beta)) =
  E(\vec{\pi}^{(\mathcal{A}, \beta)}, T(\mathcal{I}'(\mathcal{A}, \beta))) =
  E(\vec{\pi}^{(\mathcal{A}, \beta)},\mathcal{I}(\mathcal{A}, \beta)) =
  \gamma^{(\mathcal{A}, \beta)} $, where $\vec{\pi}^{(\mathcal{A}, \beta)} =
  (\pi^{(\mathcal{A}, \beta)}_1, \ldots, \pi^{(\mathcal{A}, \beta)}_m)$ and
  $\vec{\epsilon}^{(\mathcal{A}, \beta)} = (\epsilon^{(\mathcal{A}, \beta)}_1,
  \ldots, \epsilon^{(\mathcal{A}, \beta)}_m)$, and from the inductive
  hypothesises, $\vec{\pi}^{(\mathcal{A}, \beta)} =
  \vec{\epsilon}^{(\mathcal{A}, \beta)}$. This concludes the proof of
  statement~\ref{obj:left-right}.
  
  % that if is defined if, and only if, $\mathcal{I}' (\mathcal{A}, \beta)$ is
  % defined. Suppose $\mathcal{I}(\mathcal{A}, \beta)$ is defined. Let
  % $\mathcal{B} = \mathcal{I} (\mathcal{A}, \beta)$ with coordinate map $h$. It
  % is not hard to verify that $T(\mathcal{B}) = \mathcal{I}'(\mathcal{A},
  % \beta)$
  % with coordinate map $h$. Suppose $\mathcal{I}' (\mathcal{A}, \beta)$ is
  % defined and $\mathcal{B}' = \mathcal{I}'(\mathcal{A}, \beta)$.

  % $h$


  % It follows that if $\mathcal{I}(\mathcal{A}, \beta)$ is not defined then
  % $\gamma^{(\mathcal{A}, \beta)} = (\gamma')^{(\mathcal{A}, \beta)}$. Suppose
  % $\mathcal{I}(\mathcal{A}, \beta)$ is defined. Then
  
  % It can be shown that $\gamma'$ translates $\gamma$. Statement (1) follows.

  We next prove statement~\ref{obj:FOC-right-left}. The proof is by a similar
  induction. Let $\gamma'$ be a number-term or formula of $L(\setop_{E'})$. We
  show that there is corresponding number-term or formula $\gamma \in
  L(\setop_{E})$ that translates $\gamma$. Again, the only interesting case is
  the application of an operator. Suppose
  \begin{align*}
    \gamma' = \Omega_{E', \ar'}[\vec{\epsilon}\,][\vec{\psi}^D, \vec{\psi}^{\approx}] ((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\psi_i))_{i \in [r']},
  \end{align*}
  for some $\ar' : S' \times [2] \ra \nats$. Let
  \begin{align*}
    \gamma := \Omega_{E, \ar} [\vec{\pi}] [\vec{\phi}^D, \vec{\phi}^{\approx}]  [((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\phi_i))_{i \in [r]}&((\vec{x}^{r + j}_1 \vec{\mu}^{r + j}_1, \ldots, \vec{x}^{r + j}_{f_j} \vec{\mu}^{r+j}_{f_j})(\eta_j))_{j \in [f]}],
  \end{align*}
  where
  \begin{myitemize}
  \item $\ar : S \times [2] \ra \nats$ and $\ar = \restr{\ar'}{S \times [2]}$;
  \item $\vec{\pi} = (\pi_1, \ldots, \pi_m)$ and for each $j \in [m]$, $\pi_j$
    is the translation $\epsilon_j$;
  \item $\vec{\phi}^D = (\phi^D_1, \ldots, \phi^D_{q})$, where for all $i \in
    [q]$, $\phi^D_i$ is the translation of $\psi^D_i$;
  \item $\vec{\phi}^{\approx} = (\phi^{\approx}_1, \ldots, \phi^{\approx}_q)$,
    where for all $i \in [q+1]$, $\phi^{\approx}_i$ is the translation of
    $\psi^\approx_i$;
  \item for all $i \in [r']$, $\phi_i$ is the translation of $\psi_i$; and
  \item for all $i \in [f]$ and $j \in [f_j]$, $\eta_i := \#_{\vec{x}^{r +
        i}_{f_i + 1}\vec{\mu}^{r + i}_{f_i + 1}}[\phi^D_{q+1},
    \phi^\approx_{q+1}] \cdot \phi_{r+i}$.
  \end{myitemize}
  
  It remains to show that $\gamma$ translates $\gamma'$. Let $\mathcal{A} \in
  \fin{\rho}$ and let $\beta$ be an assignment to $\vec{w}$ in $\mathcal{A}$.
  Let $\mathcal{I} = (\vec{\phi}^D, \vec{\phi}^{\approx}, (\phi_i))_{i \in [r]},
  (\eta_j))_{j \in [f]})$ be the $L(\Omega_{E, \ar})[\rho, \tau]$-interpretation
  defined in $\gamma$ and let $\mathcal{I}'$ be the corresponding $L(\Omega_{E,
    \ar})[\rho, \tau']$-interpretation defined in $\gamma'$. Following the same
  approach as for statement~\ref{obj:left-right}, we need to show (i) if
  $\mathcal{I}(\mathcal{A}, \beta)$ is defined then $\mathcal{I}'(\mathcal{A},
  \beta)$ is defined and $\mathcal{I}(\mathcal{A}, \beta) =
  T(\mathcal{I}'(\mathcal{A}, \beta))$ and (ii) if $\mathcal{I}'(\mathcal{A},
  \beta)$ is defined then $\mathcal{I}(\mathcal{A}, \beta)$ is defined.

  Suppose $\mathcal{B} := \mathcal{I}(\mathcal{A}, \beta)$ with coordinate map
  $h$. We aim to show that $\mathcal{I}'(\mathcal{A}, \beta)$ is defined and
  $T(\mathcal{I}'(\mathcal{A}, \beta)) = \mathcal{B}$. Let $B = \uplus_{i \in
    [q]}B_i$ be the universe of $\mathcal{B}$. Let $B_{q + 1} = [(n + 1)^{t} -
  1]_0$. Let $\mathcal{B}'$ be the $\tau'$-structure with universe $B' =
  \uplus_{i \in [q+1]} B_i$ and such that for all $i \in [r']$ if $i \leq r$
  then $R^{\mathcal{B}'}_i = R^{\mathcal{B}}_i$ and otherwise
  $R^{\mathcal{B}'}_i = \{(b_1, \ldots, b_{r_i} ) : F^{\mathcal{B}} (b_1,
  \ldots, b_{r_i - 1}) > b_{r_i}\}$. Let $h' : \uplus_{i \in [q +
    1]}(\phi^D_i)^{(\mathcal{B}', \beta)} \ra \uplus_{i \in [q+1]} B_i$ be
  defined for $\vec{a} \in \uplus_{i \in [q + 1]}(\phi^D_i)^{(\mathcal{B}',
    \beta)}$ such that if $\vec{a} \in \uplus_{i \in
    [q]}(\phi^D_i)^{(\mathcal{B}', \beta)}$ then $h'(\vec{a}) = h(\vec{a})$ and
  otherwise $h'(\vec{a}) = \sum_{l \in [\vert \vec{a} \vert]} a_l (n + 1)^{l -
    1}$. It remains to show that $\mathcal{B}' = \mathcal{I}'(\mathcal{A},
  \beta)$ with coordinate map $h'$ and that $T(\mathcal{B}') = \mathcal{B}$.
  Both of these statements follow from a very similar argument as in
  Claim~\ref{claim:not-to-dash}.

  Suppose $\mathcal{B}' = \mathcal{I}'(\mathcal{A}, \beta)$ with coordinate map
  $h'$. We aim to show that $\mathcal{I}(\mathcal{A}, \beta)$ is defined. Let
  $B' = \uplus_{i \in [q+1]} B_i$ be the universe of $\mathcal{B}'$. Let
  $\mathcal{B}$ be the $\tau$-structure with universe $B := \uplus_{i \in [q]}
  B_i$ and such that for all $R_i \in R$, $R^{\mathcal{B}}_i =
  R^{\mathcal{B}'}_i$ and for all $F_i \in F$, $F^{\mathcal{B}}_i (b_1, \ldots,
  b_{f_i})= \vert \{b \in B_{q + 1} : (b_1, \ldots, b_{f_i}, b) \in
  R^{\mathcal{B}'}_{i + r}\}\vert$. Let $h = \restr{h'}{B}$. It is easy to see
  that $T(\mathcal{B}) = \mathcal{B}'$. Again, it can be shown, following a
  similar argument as in Claim~\ref{claim:not-to-dash}, that $\mathcal{B} =
  \mathcal{I}(\mathcal{A}, \beta)$.

  It follows then that if $\mathcal{I}(\mathcal{A}, \beta)$ is not defined then
  $\mathcal{I}'(\mathcal{A}, \beta)$ is not defined, and if
  $\mathcal{I}(\mathcal{A}, \beta)$ is defined then $\mathcal{I}(\mathcal{A},
  \beta) = T(\mathcal{I}'(\mathcal{A}, \beta))$. It follows that
  $(\gamma')^{(\mathcal{A}, \beta)} = \gamma^{(\mathcal{A}, \beta)}$. This
  concludes the proof of statement~\ref{obj:FOC-right-left}, and the
  proposition.
  
  % We aim to show that $\mathcal{B} = \mathcal{I}(\mathcal{A}, \beta)$ and
  % $T(\mathcal{B}) = \mathcal{I}(\mathcal{A}, \beta)$. Let $\mathcal{B}' :=
  % \mathcal{I}'(\mathcal{A}, \beta)$ with universe $B' = \uplus_{i \in [q +1]}
  % B_i$ and coordinate map $h'$. Let $\mathcal{B}$ be the $\tau$-structure with
  % universe $B := \uplus_{i \in [q ]} B_i$ and such that for each $R_i \in R$,
  % $R^{\mathcal{B}}_i = R^{\mathcal{B}'}_i$ and for all $F_i \in F$ we have
  % $F^{\mathcal{B}}(b_1, \ldots, b_{f_i}) = \vert \{b \in B_{q + 1} : (b_1,
  % \ldots, b_{f_i}, b) \in \} \vert$

  % be the coordinate
  
  % Let $T' : \fin[\tau] \ra \fin[\tau']$ be defined such that for each
  % $\mathcal{B} \in \fin[\tau]$ with universe $B = \uplus_{i \in [q + 1]}B_i$
  % we
  % have that
  % \begin{myitemize}
  % \item $T'(\mathcal{B})$ has universe $(\uplus_{i \in [q]}B_i) \uplus
  %   B_{q+1}$,
  %   where $B_{q+1} = [(n + 1)^t - 1]$,
  % \item for all $R_i \in R'$, $R^{T'(\mathcal{B})}_i = R^{\mathcal{B}}_i$, and
  % \item for all $F_j \in F'$, $F^{T'(\mathcal{B})}_j(b_1, \ldots, b_{f_j}) =
  %   \vert \{ b \in B_{q+1}': (b_1, \ldots, b_{f_j}, b) \in R^{\mathcal{B}}_{r
  %   +
  %   j}\} \vert$.
  % \end{myitemize}
  % It can be shown that $T'$ is the inverse of $T$. It is not hard to show,
  % following a broadly similar strategy to the one in Claims~\ref{} and~\ref{},
  % that if $\mathcal{I}'(\mathcal{A}, \beta)$ is not defined then
  % $\mathcal{I}(\mathcal{A}, \beta)$ is not defined, and if
  % $\mathcal{I}'(\mathcal{A}, \beta)$ is defined then
  % $\mathcal{I}'(\mathcal{A},
  % \beta) = T'(\mathcal{I}(\mathcal{A}, \beta))$. In either case, following the
  % same argument, we get $(\gamma')^{(\mathcal{A}, \beta)} =
  % \gamma^{(\mathcal{A}, \beta)}$. This concludes the proof of (5).

  % is defined and is not defined. Then, from Claim~\ref{claim:not-to-dash},
  % $\mathcal{I}'(\mathcal{A}, \beta)$ is not defined and so
  % $\gamma^{(\mathcal{A}, \beta)} = 0 = (\gamma')^{(\mathcal{A}, \beta)}$.
  % Otherwise, $\mathcal{I}(\mathcal{A}, \beta)$ is defined and so, from
  % Claim~\ref{claim:dash-to-not}, $\mathcal{i}'(\mathcal{a}, \beta)$ is
  % defined
  % and $\mathcal{I}(\mathcal{A}, \beta) = T(\mathcal{I}'(\mathcal{A},
  % \beta))$.
  % Then $(\gamma')^{(\mathcal{A}, \beta)} = E'(\vec{p},
  % \mathcal{I}'(\mathcal{A},
  % \beta)) = E(\vec{p}, T(\mathcal{I}'(\mathcal{A}, \beta))) =
  % E(\vec{p},\mathcal{I}(\mathcal{A}, \beta)) = \gamma^{(\mathcal{A}, \beta)}
  % $,
  % where $\vec{p} = (p_1, \ldots, p_m)$ and for each $i \in [m]$ we have $p_i
  % =
  % \pi^{(\mathcal{A}, \beta)}_i$. This concludes the proof of (3).

  % It It is easy to show that $\gamma'$ and $\gamma$ have the same free
  % variables
  % and the same semantics, and so statement (3) follows. Statement (2) follows
  % from a very similar proof, except in this case we have that for each $j \in
  % [f]$, and $R_{j+r}'$ the sort $\zeta'(R_{j+r})(f_i + 1)$ is defined using
  % only
  % numbers. It follows that we can replace the application of the counting
  % operator above with a formula that includes a fixed-point operator.
  % Statement
  % (4) follows from statement (1) and (3).
\end{proof}

% \begin{prop}
%   Let $L$ be an extension of $\FP^{\nats}$ and let $\setop$ be a set of
%   generalised operators. Suppose $L(\setop)$ has constant definable-number
%   width. There is a family of Boolean-valued generalised operators that act on
%   formulas $\setop'$ such that $L(\setop) \equiv L(\setop')$.
%   \label{prop:operators-to-boolean}
% \end{prop}

% \begin{proof}
%   From Lemma~\ref{prop:operators-to-onformulas} we may assume, without a loss
%   of generality, that the operators in $\setop_E$ acts on formulas. Let $E' :
%   \nats^{m + 1} \times \fin[\tau] \ra \{0,1\}$ be defined such that
%   $E'(\vec{a}, b, \mathcal{A}) = 1$ if, and only if, $E(\vec{a}, \mathcal{A})
%   = b$ for all $\vec{a} \in \nats^m$, $b \in \nats$, $\mathcal{A} \in
%   \fin[\tau]$.

%   We first show that $L(\setop_E) \leq L(\setop_{E'})$. Let $\theta(\vec{x})
%   \in L(\setop_E)$. We prove this result by induction on the structure of
%   $\theta(\vec{x})$. Let $\gamma$ be a sub-formula or sub-number-term in
%   $\theta(\vec{x})$. The interesting case is where $\gamma$ is an application
%   of an operator in $\setop_E$. Suppose then
%   \begin{align*}
%     \gamma = \Omega_{E, \ar}[\vec{\pi}][\vec{\phi}^D, \vec{\phi}^{\approx}] ((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\phi_i))_{i \in [r]}.
%   \end{align*}
%   is a number term, and let $\psi(\vec{x})$ be a formula that contains
%   $\gamma$ and such that $\psi$ does not strictly contains a formula that
%   contains $\gamma$. It follows that $\psi$ is of the form $\gamma X \delta$,
%   where $\delta$ is a number term and $X$ is either `$=$' or `$\leq$'. Let
%   $\vec{\epsilon}$ be a $t$-length vector of variables not in $\theta$ and
%   assume we have already defined a number-term $\delta' \in L(\setop_{E'})$,
%   that translates $\delta$. Let $\psi' = \exists \vec{\epsilon} \, \gamma'
%   \land \, \vec{\epsilon} X \delta'$, where $\gamma'$ is a formula defined
%   such that
%   \begin{align*}
%     \gamma' = \Omega_{E', \ar}[\vec{\pi}', (\epsilon_1 + \epsilon_2 \cdot (M+1) + \ldots + \epsilon_t \cdot (M+1)^{t-1})][\vec{\psi}^D, \vec{\psi}^{\approx}] ((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\psi_i))_{i \in [r]}
%   \end{align*}
%   where
%   \begin{myitemize}
%   \item $\vec{\pi}$ is a translation of $\vec{\pi}'$,
%   \item $M$ is the size of the structure and for each $i \in [t - 1]$
%     $(M+1)^{i}$ is the $i$th power of $M+1$,
%   \item $\vec{\psi} = (\psi^D_1, \ldots, \psi^D_{q})$, where for all $i \in
%     [q]$, $\psi^D_i$ is the translation of $\phi^D_i$,
%   \item $\vec{\psi}^{\approx} = (\psi^{\approx}_1, \ldots, \psi^{\approx}_q)$,
%     where for all $i \in [q]$, $\psi^{\approx}_i$ is the translation of
%     $\phi^D_i$, and
%   \item for all $i \in [r]$, $\psi_i$ is the translation of $\phi_i$.
%   \end{myitemize}
%   It can be shown that $\gamma'$ translates $\gamma$, and hence $L(\setop_E)
%   \leq L(\setop_{E'})$. It remains to show that $L(\setop_{E'}) \leq
%   L(\setop_{E})$. We prove this by induction on the structure of a formula or
%   number-term. Let $\gamma$ be a number-term of formula in $L(\setop_{E'})$.
%   The base cases follow from the observation that if $\gamma \in L$ then
%   $\gamma \in L(\setop_E)$. Let $\gamma $


%   The idea is to simply replace any application of a (Boolean-valued) operator
%   in $\setop_{E'}$ with formula that tests for the equality. We omit the
%   details here.
% \end{proof}

% It follows from Lemmas~\ref{} and~\ref{} that we may assume, without a loss of
% generality, that so long as we are interested in logics that are extensions of
% $\FOC$, any given set of generalised operators $\setop$ is normal.

% We have defined the extension of a logic by an operator so as to allow for the
% inclusion of man the operator we may also specify formulas (e.g.\
% $\vec{\phi}^D, \vec{\phi}^{\approx}$) that may be used to restrict the domain
% and introduce a quotienting operator.


% The definition of extending a logic by a family of operators the possibility
% of defining a many-sort interpretation as part of the application of the
% operator. In many cases extension of a logic by a family of Lindstr\"{o}m
% quantifiers does not allow for the taking of interpretations. We can similarly
% define for a logic $L$ and set of operators $\setop$ an extension
% $L^{~}(\setop)$ that is defined similarly, but that does not allow for any
% definition of a

% \begin{definition}
%   We say a logic $L(\setop)$ is \emph{closed under operator quotients} if
%   $L^{~}(\setop) = L(\setop)$.
% \end{definition}

% We state the following easy to prove lemma.

% \begin{lem}
%   The logics $\FP^{\nats}$, $\FPC$, and $\FPR$ are closed under operator
%   quotients.
%   \label{lem:logics-operator-quotients}
% \end{lem}



% For each $i \in [q]$ let $B_i = \phi^D_i / \phi^{\approx}_i$. Let $i \in
% [l_1]$. For each $j \in [r_i]$ let $e_j \in B_{\zeta(R_i)(j)}$. We define
% $R^B_i$ by $(e_1, \ldots, e_{r_i}) \in R^{B}_i$ if, and only if, there exists
% $(\vec{a}_1 \vec{m}_1, \ldots , \vec{a}_{r_i} \vec{m}_{r_i})$ where $\vec{a}_j
% \vec{m}_j \in e_j$ for all $j \in [r_i]$ and $\mathcal{A} \models \theta_i
% [\vec{a}_1\vec{m}_1, \ldots, \vec{a}_{r_i} \vec{m}_{r_i}]$. We define
% $F^{B}_j$ such that $F^B_j (e_1, \ldots, e_{f_j}) = k$ there exists
% $(\vec{a}_1, \vec{m}_1, \ldots , \vec{a}_{r_i} \vec{m}_{r_i})$ such that
% $\vec{a}_j \vec{m}_j \in e_j$ for all $j \in [f_i]$ where $\mathcal{A} \models
% (k = \nu_i [\vec{a}_1, \vec{m}_1, \ldots , \vec{a}_{r_i} \vec{m}_{r_i}])$. Let
% $\mathcal{B}$ be the structure defined from the above. We have $\mathcal{A}
% \models (k = ...)$ if, and only if, $E(\vec{\pi}^{\mathcal{A}},
% \vec{\phi}^{\mathcal{A}}, \mathcal{B}) = k$.


% \begin{definition}
%   Let $\Omega_{E, \ar}$ be a many-sorted operator. We say $\Omega_{E, \ar}$
%   \emph{operates on formulas} if there are no function symbols in the
%   vocabulary of $\Omega_{E, \ar}$. We say that $\Omega_{E, \ar}$ \emph{has no
%   parameters} if the parameter-width is zero. We say $\Omega_{E, \ar}$ is
%   \emph{numberless} if it operates on formulas and for all $s \in S$, $\ar(s,
%   2) = 0$. We call a numberless Boolean operator a \emph{many-sorted
%   quantifier}.
% \end{definition}

% \begin{lem}
%   Let $L$ be a logic and $\setop$ be a set of operators. There is a set of
%   operators $\setop^*$ each of which operate on formulas such that $L(\setop)
%   \equiv L(\setop^*)$.
% \end{lem}
% \begin{proof}
  
% \end{proof}

% It follows that we may assume, without a loss of generality, that a given set
% of operators act on formulas.


% We say that $L(\setop)$ is \emph{closed under operator quotients} if each
% query in $L(\setop)$ can be expressed in

% $\equiv L(\setop^-)$.

% We

% \begin{definition}
%   Let $\Omega$ be an operator. Let $\setop$ be a set of operators. Let
%   $\setop^- = \{\Omega^- : \Omega \in \setop\}$. We say that $L(\setop)$ is
%   \emph{closed under operator quotients} if $L(\setop) \equiv L(\setop^-)$.
% \end{definition}

% \begin{lem}
%   $\FPR$ and $\FPC$ are closed under operator quotients.
% \end{lem}

% \begin{lem}
  
% \end{lem}

% \subsection{Boolean-Valued Operators}
% We can add a number term parameter and the operator evaluates to a value equal
% to this number term.

% \subsection{Operators on Formulas}
% We can replace each number term with a formula with an extra type. Summation
% over this extra type gets you back to the previous formula.

% We may thus assume, without a loss of generality, that the operators only
% operate on formulas and are Boolean valued.

\section{Extended Quantifiers}
\label{chpt:gen-op--sec:extended-quantifiers}
There exists a translation from fixed-point logic with counting \emph{operators}
($\FPC$) to bounded-variable infinitary logic with counting \emph{quantifiers}
($\infcount$). This translation has been crucial for proving numerous important
inexpressibility results for $\FPC$, including the separation of $\FPC$ from
$\PT$~\cite{}. We aim to generalise this translation. We should first like to
show that each set of generalised operators $\setop$ has corresponding set of
quantifiers $\setquant$, generalising the relationship between counting
operators and counting quantifiers. But generalised operators are defined over
many-sorted structures, admit parameters, may quantify over the number domain,
and are otherwise quite different from {\lindstrom} quantifiers. In this section
we introduce the notion of an \emph{extended quantifier}. These quantifiers are
similar to generalised operators in being defined by a class of many-sorted
structures and in some sense being able to `simulate' quantification over the
number sort. We show that each set of generalised operators has a corresponding
set of extended-quantifiers. We begin by formally defining an
extended-quantifier.

% number-terms

% We then show that each formula of $\FP(\Omega)$ can be translated to a formula
% of bounded-variable infinitary logic extended by $\setop$.

% However, generalised operators are defined over many-sorted structures, admit
% parameters, and may in general not be as well behaved as counting operators.
% As such,

% As such, we introduce a new sort of quantifier, called an extended-quantifier,
% that is similarly


% However, gen

% We aim to generalise this translation.

% We first show that each set of generalised operators may be associated with a
% set of quantifiers.


% for fixed-point logics extended generalised operators.


% A similar translation from $\FPRD$ to bounded-variable infinitary logic with
% rank \emph{quantifiers} was given by Holm~\cite{}. These

% We will present a generic approach for translating generalised operators to in
% However, generalised operators are defined over many-sorted structures, admit
% parameters, and lack some of the other properties of counting operators used
% for this translation. In order to complete this translation

% As such, we introduce a more general notion of a quantifier, called an
% \emph{extended quantifier}, and show that fixed-point logic with
% \emph{generalised operators} correspond


% These bounded-variable infinitary logics often have combinatorial
% characterisations of their expressive power that can be very useful for
% proving inexpressibility results. We aim


% the less expressive power to infinitary logics has been defined by
% Holm~\cite{} for the less expressive rank logic of Dawar et al~\cite{}. These
% infinitary logics often admit game-based characterisations of their expressive
% power (see~\cite{}) and these translations from fixed


% has been very useful for proving numerous important results -- e.g.\
% separating $\FPC$ from $\PT$~\cite{}. We will establish a similar result for
% generalised operators.

% , but, as generalised operators are defined over a broader class of structures
% and in general may not have some of the useful properties counting operators
% pocess, we will


% A standard approach for studying the expressive power of fixed-point logics,
% including $\FPC$ and $\FPR$, involves associating with each of these logics a
% more expressive bounded-variable (single-sorted) infinitary logic. These
% infinitary logics often admit pebble-game based characterisations (see~\cite{}
% or~\cite{}) and are much simplier to analyses. As such, this correspondence
% between fixed-point and infintary logics has proved a very useful for proving
% inexpressibility results.In this section we present a general construction
% that associates with each set of operators $\setop$ a set of \emph{extended
% quantifiers} $\setquant$ such that $\FP^{\nats}(\setop) \leq
% \mathcal{L}^{\omega}(\setquant)$.

% We could think of an extended quantifier as being similar to a lindestrom
% quantifier but with two important differences. First, extended quantifiers are
% defined by classes of many-sorted structures and interpretations, rather than
% relational stuctures and interpretations. Second, extended quantifiers have a
% more complex syntax that allows them to `simulate' number variables. We will
% now formally define extended quantifiers.




% Extended quantifiers are defined by a class of many-sorted structures. An
% application of a quantifier in a formula defines an interpretation, with the
% formula evaluating to true for a given structure if, and only if, the
% interpretation is a member of the class of structures.


% Extended quantifiers generalise Lindestrom quantifiers. Extended quantifiers
% generalise Lindestrom quantifiers in two respects.


% Extended quantifiers defined by a class of many-sorted

% are similar to Lindestrom quantifiers in being define by a class of
% structures, except that extended quantifiers are

% are defined by a class of relational structures, extended quantifiers are
% defined by a class of many-sorted structures. However, the syntax used to
% define the interpretation


% in that they are defined by a class of structures

% quantifiers are defined over classes of structures, extended quantifiers are
% defined over classes of many-sorted structures. The semantics of an extended
% quantifier is also defined in order to allow for the simulation of number
% terms. We now define this notion of an extended quantifier formally.


% We may think of extended quantifiers as being an extension of Lindestrom
% quantifiers that extends Lindestrom quantifiers


% extended quantifiers introduce a slightly complex syntax that allows us to are
% similar to Lindestrom quantifiers, except that each such quantifier is
% associated a set of


% differ from Lindestrom quanitifers in being defined from

% We may think of extended quantifiers as being similar to generalised
% quantifiers.

% are similar to generalised operators in that they are defined by an evluation


% are similar to Lindestrom quantifiers in that they are defined by a class of
% structures, However, like generalised operators, and unlike Lindestrom
% quantifiers, they are defined by a class of many-sorted structures

% operators in that they are assosiated with classes of structures defined over


% in this chapter thus far. We now provide a general approach for assosiating a
% given fixed-point logics with some generalised operators and

% In this section we present a generic construction, and show how to associate
% with each extension of fixed-point logic with a set of generalised operators
% with a bounded-variable infinitary logic.

% In this section we show that each set of operators $\setop$ defines a
% corresponding set of quantifiers $\setquant$ such that $\FP^{\nats} (\setop)
% \leq \mathcal{L}^{\omega}()$






% We then prove lower-bounds for the corresponding infinitary logic, and these
% lower bounds then hold for the corresponding fixed-point logic as well.


% $\FO^{\nats}(\Omega)$ is to define some set quantifiers $Q$



% Many of the logics of interest in finite model theory are extensions of
% fixed-point logics with some set


% It was shown by blah~\cite{} and blah~\cite{} that $\FP^{\nats} \leq
% \mathcal{L}^\omega$ and $\FPC \leq \mathcal{C}^{\omega}$. There is a similar
% result for the rank logic of Dawar et al.~\cite{} by Holm~\cite{}.


% These results allow us to prove inexpressibly results for fixed-point logics
% by instead proving inexpressibly results for a corresponding extension of a
% bounded-variable infinitary logic, have proved very useful in finite model
% theory (see~\cite{}).

% These results, allow us to study extensions of fixed-point logics by some
% operator

% In finite model theory most of the logics of interest are extensions of
% fixed-point or first-order logics by some set of operators. One important
% approach for studying these logics is to define for each of them an associated
% set of quantifiers and


% The study of infinitary logics, and particularly bounded-variable infinitary
% logics, A standard approach for studying $\FPC$, $\FPR$ and other extension of
% $\FP^\nats$ is to define some extension of the bounded-variable
% (single-sorted) infinitary logic and show that the fixed point logic is
% contained in t


% show that the fixed-point logic is contained in some infinitary logic
% $\mathcal{L}^{\omega}(\setquant)$, where $\setquant$ is some set of
% quantifiers. In this section we generalise this argument. We first define new
% sort of quantifier, called an \emph{extended quantifier}.


% which is similar to a Lindestrom quantifier but is


% a similar not and show that each set of generalised operators $\setop$ defines
% a set of extended quantifiers $\setquant$ such that $\FP^{\nats}(\setop) \leq
% \mathcal{L}^{\omega}(\setquant)$.




% strictly contained in some finite variable A standard approach for studying
% $\FPC$ has been to associate with the counting operator a set of counting
% quantifiers $(C^{>k})_{k \in \nats}$, and then to show that each formula in
% $\FPC$ is equalivent to a formula in $\mathcal{L}$and then to show that each
% formula in $\FPC$ is and then show that each


% Many of the logics of interest in finite model theory, including $\FPC$ and
% $\FPR$, can be defined as extension of $\FP^{\nats}$ by generalised operators.
% A standard approach for studying the expressive power of these logics involves
% associating with the operators a class of quantifiers, and then showing that
% each formula in the fixed-point logic is equivalent to a formula of
% bounded-variable infinitary logic without number sorts (e.g.\ $\FPC \leq
% \mathcal{L}^\omega ((\mathcal{C}^{\geq k})_{k \in \nats})$).

% We aim to develop a general way of associating with each logic extended by a
% set of generalised operators with an appropriate infinitary logic. Before we
% do so, we need to show how to associate a set of operators with an appropriate
% set of quantifiers that make no reference to a number sort. In this subsection
% we introduce \emph{extended quantifiers}. A

Let $\tau = (R, S, \zeta)$ be a many-sorted vocabulary where $R = \{R_1, \ldots,
R_{r}\}$, and $S = \{s_1, \ldots, s_{q}\}$. For each $i \in [r]$ let $r_i$
denote the arity of $R_i$. Let $D$ be a class of $\tau$-structures, $\ar : S
\times [2] \ra \nats$, and $n \in \nats$. We associate with a triple $(D, \ar,
n)$ an \emph{extended quantifier} $Q^n_{D, \ar}$. We call $D$ the \emph{class of
  structures}, $\ar$ the \emph{arity}, and $n$ the \emph{cardinality} of
$Q^n_{D, }$. For each $i \in [r]$, $l \in [r_i]$ let $s^i_l = \zeta (R_i)(l)$
and let $c^i_l = \ar(s^i_l, 2)$. Let $T^i := \numdompow{n}{c^i_l} \times ,
\ldots, \times \numdompow{n}{c^i_{r_i}}$. We call $T := (T_i, \ldots, T_i)$ the
\emph{number domain} of $Q^n_{D, \ar}$. For a logic $L$ the extension
$L(Q^{n}_{D, \ar})$ is defined by extending the formula-formation rule for $L$
as follows:
\begin{textbox}[13.8cm]
  For each $i \in [r]$ let $\Upsilon_i : T^i \ra L(Q^{n}_{E, \ar})$ and for each
  $l \in [r_i]$ let $\vec{x}^i_l$ be an $\ar(s^i_l, 1)$-length tuple of element
  variables. For each $z \in [q]$ let $\vec{x}_z$, $\vec{y}^1_z$, and
  $\vec{y}^2_z$ be $\ar(s_z, 1)$-sequences of variables. Let $\vec{w}$ be a
  sequence of variables and let $\vec{\phi}^D := (\phi^D_1(\vec{x}_1; \vec{w}),
  \ldots, \phi^D_q(\vec{x}_q; \vec{w}))$ and $\vec{\phi}^\approx :=
  (\phi^\approx_1(\vec{y}^1_1, \vec{y}^2_1; \vec{w}), \ldots,
  \phi^{\approx}_q(\vec{y}^1_q, \vec{y}^2_q; \vec{w}))$ be $L(Q^{n}_{D,
    \ar})$-formulas. Then
  \begin{align*}
    \phi := Q^{n}_{D, \ar} [\vec{\phi}^D,
    \vec{\psi}^D][(\vec{x}^i_1, \ldots, \vec{x}^i_{r_i}) \cdot \Upsilon_i]_{i \in
    [r]},
  \end{align*}
  is a formula in $L(Q^{n}_{D, \ar})$. Let
  \begin{align*}
    \free{\phi} := \bigcup_{i \in [q]} [(\free{\phi^D_i} \setminus
    \vec{x}_i) \cup (\free{\phi^\approx_i} \setminus
    (\vec{y}^1_i \cup \vec{y}^2_i))] \cup \uset{i \in [r]}{a \in T_i}{\bigcup}(\free{\Upsilon_i(a)} \setminus (\bigcup_{j \in
    [r_i]}\vec{x}^i_j)).
  \end{align*}
\end{textbox}
The semantics of the formula $\phi$ is defined for a structure $\mathcal{A} \in
\fin{\rho}$ and assignment $\alpha$ to the free variables in $\phi$ as follows:
\begin{textbox}[14.0cm]
  For each $i \in [r]$ let
  \begin{align*} \chi_i (\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i}
    \vec{\mu}^i_{r_i}) := \bigvee_{(\vec{a}_1, \ldots, \vec{a}_{r_i}) \in
      T_i}[(\bigwedge_{j \in [r_i]} \vec{\mu}^i_j= \vec{a}_j) \land
    \Upsilon_i(\vec{a}_1, \ldots, \vec{a}_{r_i})(\vec{x}^i_1, \ldots,
    \vec{x}^i_{r_i})].
  \end{align*}
  be a formula in the extension of $L(Q^{n}_{E, \ar})$ by a number sort and for
  each $j \in [q]$ let $\vec{\mu}_j$, $\vec{\nu}^1_j$, and $\vec{\nu}^2_j$ be
  $\ar(s_j, 2)$-sequences of number variables. Let $\psi^D_j(\vec{x}_j
  \vec{\mu}_j) := (\vec{\mu}_j = \vec{\mu}_j) \land \phi^D_j (\vec{x}_j)$ and
  $\psi^\approx_j(\vec{y}^1_j \vec{\nu}^1_j, \vec{y}^2_j \vec{\nu}^2_j; \vec{w})
  := (\vec{\nu}^1_j = \vec{\nu}^2_j)\land \phi^\approx_j (\vec{y}^1_j ,
  \vec{y}^2_j ; \vec{w})$. Let $\mathcal{I} = (\vec{\psi}^D, \vec{\psi}^\approx,
  (\chi_i)_{i \in [r]})$ be an interpretation. Then
  \begin{align*}
    \mathcal{A} \models \phi [\alpha] \text{ if, and only if, } \mathcal{I}(\mathcal{A},
    \alpha) \text{ is defined and } (\mathcal{I}(\mathcal{A}), \alpha)) \in D.
  \end{align*}
  We call $\mathcal{I}$ the \emph{interpretation defined by $\phi$}.
  %\vspace{-5mm}
\end{textbox}
Let $\setop$ be a set of operators that act on formulas. Let $\Omega_{E, \ar}
\in \setop$, and let $m$ be the parameter-width of $\Omega_{E, \ar}$. For each
$\vec{p} \in \nats^m$ and $k \in \nats$ let $D_{\vec{p}, k} := \{ \mathcal{B}
\in \fin{\tau} : E(\vec{p}, \mathcal{B}) = k\}$, and for each $n \in \nats$ let
$Q^{n, \vec{p}, k}_{E, \ar} := Q^n_{D_{\vec{p}, k}, \ar}$. Let $\setquant_{E,
  \ar} = \{Q^{n, \vec{p}, k}_{E, \ar} : n, k \in \nats, \vec{p} \in \nats^m\}$
and let $\setquant_{\setop} = \bigcup_{\Omega_{E, \ar} \in \setop} \setquant_{E,
  \ar}$. We call $\setquant_\setop$ the \emph{set of quantifiers corresponding
  to $\setop$}. If $\setop$ is a set of Boolean operators we may omit the $k$ in
the superscript, i.e.\ we write $Q^{n, \vec{p}}_{E, \ar}$ instead of $Q^{n,
  \vec{p}, 1}_{E, \ar}$ and $\setquant_{E, \ar} = \{Q^{n, \vec{p}}_{E, \ar} : n
\in \nats, \vec{p} \in \nats^m\}$.

\begin{definition}
  Let $Q$ be an extended quantifier. We say $Q$ is \emph{numberless} if $\ar$ is
  the arity of $Q$ and for each sort symbol $s$ in the vocabulary of $Q$ we have
  $\ar(s, 2) = 0$. We say $Q$ is \emph{single-sorted} if the vocabulary of $Q$
  is single-sorted.
\end{definition}

As for generalised operators and {\lindstrom} quantifiers we can speak of
extending a logic by a quantifier so as to exclude any quotienting or domain
restriction. We let $\exlogic{L}{\setquant}$ denote the subset of $L(\setquant)$
consisting of all those formulas and number-terms with the property that if they
include an application of an extended-quantifier in $\setquant$ then the domain
formulas in the application are all tautologies and the equality formulas all
express equality. As for generalised operators, in this case we exclude the
domain and equality formulas when applying the quantifier.

We have asserted that generalised operators and extended-quantifiers generalise
{\lindstrom} quantifiers. We now formalise this assertion.

\begin{lem}
  Let $L$ be a logic and let $\rho$ be a relational vocabulary. Let $Q$ be a
  {\lindstrom} quantifier. There exists a single-sorted Boolean generalised
  operator $\Omega$ that operators over the structure, and has no parameters and
  there exists a single-sorted, numberless extended-quantifier $Q'$ such that
  $L(Q) \equiv L(Q') \equiv L(\Omega)$.

  % Moreover, if we wet $P$ be an extended-quantifier then exists a Boolean
  % operator $\Omega$ with no parameters and that acts on formulas such that
  % $L(\Omega) = L(P)$.
\end{lem}

\begin{proof}
  % Let $P$ be an extended-quantifier with vocabulary $\tau$, class of
  % structures
  % $D$, and arity $\ar$. Let $E: \fin{\sigma} \ra \{0,1\}$ be the
  % characteristic
  % function of $D$. From the definition of

  Let $\sigma$ be the vocabulary of $Q$ and let $\mathcal{C}$ be the class of
  $\sigma$-structures that defines $Q$. Let $E : \fin{\sigma} \ra \{0,1\}$ be
  the characteristic function of $\mathcal{C}$. Let $\ar: [2] \ra \nats$ be
  defined such that $\ar (1) = 1$ and $\ar (2) = 0$. Let $Q' := Q_{\mathcal{C},
    \ar}$ and let $\Omega:= \Omega_{E, \ar}$. It is easy to see that $L(Q) =
  L(Q') \equiv L(\Omega_{E, \ar})$ and that the generalised operators and
  extended-quantifiers have all of the required properties.
\end{proof}

% \begin{remark}
%   It is easy to see that each extended

%   Let $Q^n_{D, \ar}$ be an extended quantifier and let $\tau$ be its
%   vocabulary. Let $E : \fin{\tau} \ra \{0,1\}$ be the characteristic function
%   of $D$. It is easy to see that that for any logic $L$, $L (Q^n_{D, \ar})
%   \equiv L(\Omega_{D, \ar})$.



%   We have stated that generalised operators and extended quantifiers
%   generalise {\lindstrom} quantifiers. We should formalise this relationship.
%   Let $L$ be a logic. Let $\rho$ be a relational vocabulary and let
%   $\mathcal{C}$ be a class of $\rho$-structures. Let $Q_{\mathcal{C}}$ be the
%   corresponding {\lindstrom} quantifier. Let $\tau = (\rho, \{s\}, \zeta)$ be
%   a many-sorted vocabulary. Let $E : \fin{\rho} \ra \{0,1\}$ and let $\ar:
%   \{s\} \times [2] \ra \nats$ be defined such that $\ar (s, 1) = 1$ and
%   $\ar(s, 2) = 0$. Let $n \in \nats$ and let $Q^n_{E^{-1}(1), \ar}$ be an
%   extended quantifier. Then $L(\Omega_{E, \ar}) \equiv L(Q_{\mathcal{C}})
%   \equiv L(Q^n_{E^{-1}(1), \ar})$. In other words, {\lindstrom} quantifiers
%   can be thought of as Boolean generalised operators that operate over the
%   structure, have no parameters, and have a single-sorted vocabulary.
%   Similarly, {\lindstrom} quantifiers can be thought of as numberless extended
%   quantifiers with a single-sorted vocabulary.
% \end{remark}


% Let $\setop$ be set of operators that act on formulas we can define a set of
% quantifiers $Q^{n, \vec{p}, k}_{n, k}$

% We may associate a set of operators with a set of extended quantifiers. Let
% $\setop$ be a set of generalised operators. Let $\setquant$ be the set of
% extended quantifiers such that $Q \in \setquant$ if, and only if, there exists
% $\Omega_{E, \ar} \in \setop$ with parameter-width $m$, $\vec{p} \in \nats^m$,
% and $n \in \nats$ such that $Q = Q^{E, \ar}_{\vec{p}, n}$. We say that
% $\setquant$ is the set of extended quantifiers corresponding to $\setop$.

\section{Translating Formulas to Substitution Programs}
\label{chpt:gen-op--sec:substitution-programs}
We now introduce the notion of a substitution program. A substitution program is
a finite sequence of formulas. Each formula in the sequence is associated with a
second-order variable and is defined in terms of second-order variables
corresponding to formulas that come later in the sequence. The idea is that a
substitution program is a `compact' way of writing a formula, one that allows
formulas to repeatedly apply a formula that appears later on in the sequence
without having to rewrite it each time. We use substitution programs as a step
towards our translation from fixed-point logics to infinitary logics. We also
make use of substitution programs when we translate from fixed-point logics to
circuits (see Chapter~\ref{chpt:support}). We first formally define a
substitution program.

\begin{definition}
  Let $L$ be a logic and $\rho$ be a vocabulary. A $L[\rho]$-\emph{substitution
    program} is a sequence of formulas $\Phi := (\phi_1(\vec{y}_1, \vec{\mu}_1;
  \boldsymbol{V}_1), \ldots, \phi_k(\vec{y}_k, \vec{\mu}_k;\boldsymbol{V}_k))$
  such that for each $i \in [k]$:
  \begin{myitemize}
  \item $\phi_i$ is a formula in $L[\rho]$,
  \item $\vec{y}_i$ and $\vec{\mu}_i$ are sequences of element and number
    variables, respectively,
  \item $V_i$ is a second-order variable with the same type as $(\vec{y}_i,
    \vec{\mu}_i)$, and
  \item $\boldsymbol{V}_i \subseteq \{V_j : i < j \leq k\}$.
  \end{myitemize}
  For each $i \in [k]$ the \emph{flattening} of $\Phi$ at $i$ is defined
  recursively as follows. If $i = k$ then the flattening of $\Phi$ at $i$ is
  $\phi_i$. If $i < k$ the flattening of $\Phi$ at $i$ is defined by replacing
  each second-order variable $V_j$ appearing in $\phi_i$ with the flattening of
  $\Phi$ at $j$ (i.e.\ replacing each $V_j(\vec{x})$ with $\phi_j(\vec{x})$).
  The \emph{flattening} of $\Phi$ is the flattening of $\Phi$ at $1$.

  Let $\alpha$ be an assignment to the variables $\vec{y}_1$ and $\vec{\mu}_1$.
  Let $\mathcal{A} \in \fin{\tau}$. We write $\mathcal{A} \models \Phi[\alpha]$
  to abbreviate $\mathcal{A} \models \phi[\alpha]$, where $\phi$ is the
  flattening of $\Phi$. The \emph{formula length} of a substitution program
  $\Phi$ is the maximal length (i.e.\ number of symbols) of the formulas in
  $\Phi$. The \emph{variable width} of a substitution program is the maximum
  variable width of a formula appearing in the program.
\end{definition}

We often work with substitution programs where the sequence is indexed by a
finite linearly ordered set, rather than an initial segment of the natural
numbers.

The proof of the following result follows from the standard `unrolling' of the
fixed-point operators. For more detail please see~\cite{Kolaitis1992}.

\begin{lem}
  Let $\setop$ be a set of generalised operators. If a query can be defined in
  $\FP^{\nats} (\setop)$ (resp. $\exlogic{\FP^{\nats}}{\setop}$), then it can be
  defined by a $\PT$-uniform family of $\FO^{\nats} (\setop)$-substitution
  programs (resp. $\exlogic{\FO^{\nats}}{\setop}$-substitution programs) with a
  constant bound on the variable width and formula length.
  \label{lem:unroll-fixed-point}
\end{lem}

% \begin{lem}
%   Let $\setop$ be a set of unrestricted operators. For each $n \in \nats$ let
%   $\setquant$ be the corresponding set of number domain non-uniform
%   number-domain non-quotienting quantifiers generated by $\setop$. Let
%   $\theta(\vec{x}, \vec{\mu}) \in \FO^{\nats} (\setop)$ be a formula defined
%   in terms of the mixed-sort relation variables $V_1, \ldots, V_k$. Let $m =
%   \vert \vec{\mu} \vert$ and for each $i \in [k]$ let $v_i$ be the arity of
%   the element sort and let $m_i$ be the arity of the number sort in $V_i$. Let
%   $n \in \nats$. For each $i \in [k]$ and $\vec{b} \in [n]^{m_i}$ we define an
%   element-sort relation variable $V_{\i, vec{b}}$ of arity $v_i$. There exists
%   a sequence of $\FO(\setquant)$ formulas $\{\theta_{\vec{a}}(\vec{x}) :
%   \vec{a} \in [n]^{m}\}$ where each $\theta_{\vec{a}}(\vec{x})$ is defined in
%   terms of the relation variables $\bigcup_{i \in [k]} \{V_{i, \vec{b}} :
%   \vec{b} \in [n]^{m_i}\}$.
% \end{lem}
% \begin{proof}
%   We say that a number term $\eta(\vec{y}, \vec{\nu})$ in
%   $\FO^{\nats}(\setop)$ has a \emph{translation for $n$} if there is a
%   sequence of $\FO(\setquant)$-formulas $(\phi^{\eta}_{n, k;
%   \beta}(\vec{y}))_{\beta \in [n]^{\vec{\nu}}}$ such that for each
%   $\tau$-structure $\mathcal{A}$ of size $n$ and for each assignment $\alpha
%   \in [n]^{\vec{y}}$ we have that $\mathcal{A} \models \phi^{\eta}_{n, k;
%   \beta}[\alpha]$ if, and only if, $\mathcal{a} \models (\eta = k)[\alpha \cup
%   \beta]$.

%   We say a formula $\psi(\vec{y}, \vec{\nu})$ in $\FO^{\nats}(\setop)$ has a
%   \emph{translation for $n$} if there is a sequence of
%   $\FO(\setquant)$-formulas $(\phi_{n; \beta} (\vec{y}))_{\beta \in
%   [n]^{\vec{\mu}}}$ such that each $\tau$-structure $\mathcal{A}$ of size $n$
%   and each assignment $\alpha \in [n]^{\vec{y}}$, we have that $\mathcal{A}
%   \models \phi_{n; \vec{\beta}}[\alpha]$ if, and only if, $\mathcal{A} \models
%   \phi[\alpha \cup \beta]$.

%   We aim to show that $\theta(\vec{x}, \vec{\mu})$ has a \emph{translation for
%   $n$} by induction on the structure of the formula. It is easy to see that if
%   $\eta(\vec{y}, \vec{\nu})$ is a number variable or a constant (i.e. $0$ or
%   $1$) then $\eta$ has a translation for $n$. In the case that $\psi(\vec{y})$
%   is a formula is a formula containing no number terms then there is an
%   obvious translation for $n$. If $psi(\vec{y}, \vec{\nu}) = V_i(\vec{y},
%   \vec{\nu})$ then the assignment $\psi_{n; \beta}(\vec{y}) = V_{i,
%   \beta(\vec{\nu})}$ defines a translation.

%   Let $\eta(\vec{y}, \vec{\nu})$ be a number term and suppose all sub-formulas
%   and sub-number-terms of $\eta$ have a translation for $n$. Let $\beta \in
%   [n]^{\vec{\nu}}$. Suppose $\eta(\vec{y}, \vec{\nu}) = \eta_1(\vec{y}_1,
%   \vec{\nu}_1) \cdot \eta_2(\vec{y}_2, \vec{\nu}_2)$. Let $\beta_1 \in
%   [n]^{\vec{nu}_1}$ and $\beta_2 \in [n]^{\vec{nu}_2}$ be assignments
%   compatible with $\beta$. Let $\psi^{\eta}_{n, k ; \beta} (\vec{y}) =
%   \underset{a, b \leq k, a \cdot b = k}{\bigvee}(\psi^{\eta)_1}_{n, a;
%   \beta}(\vec{x}) \land \psi^{\eta_2}_{n, b; \beta}(\vec{x}))$. The other
%   arithmetic cases are handled similarly.

%   We now consider the application of an operator. Let $\Omega \in \setop$ and
%   suppose

%   \begin{align*}
%   \eta(\vec{y}, \vec{\nu}) = \Omega_{E} [\vec{\pi}] [((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\chi_i))_{i \in [l]}].
% \end{align*}
% For each $i \in [l]$ let $T_i = [n]^{c_1} \times , \ldots, \times
% [n]^{c_{r_i}}$. Let $T$ be a function that maps $i \in [l]$ to $T_i$. where
% $c_{j}$ is the arity of ...
% \begin{align*}
%   \psi^{\eta}_{n, k; \beta}(\vec{x}) := \bigvee_{p_1, \ldots, p_{\vert \vec{\pi} \vert}, e \leq M}[&(\bigwedge_{i \leq \vert \vec{\pi}\vert} \psi^{\pi_{i}}_{n, p_i; \beta}(\vec{x})) \\ &\land Q_{E, T ; (p_1, \ldots, p_n); e} ((\vec{x}^{j, \vec{t}}_1, \ldots, \vec{x}^{j, \vec{t}}_{r_i}) \cdot (\chi_{i, \vec{t}})_{ n; \beta})_{j \in [l], \vec{t} \in T_j}]
% \end{align*}
% \end{proof}

% \begin{lem}
%   Let $\setop$ be a set of non-quotienting operators. Let $\setquant :=
%   \setquant_{\setop}$ be the corresponding set of extended quantifiers. If a
%   query can be defined by a $\PT$-uniform family of $\FO^{\nats} (\setop)$
%   substitution programs formulas then it can be defined by a $\PT$-uniform
%   family of $\FO (\setquant)$ substitution programs
% \end{lem}
% \begin{proof}
%   Let $\rho$ be a vocabulary. Let $(f_n : [M_n] \ra \FO^{\nats} \ra
%   \FO^{\nats}(\setop)[\tau])_{n \in \nats}$ be a $\PT$-uniform family of
%   $\FO^{\nats}(\setop)[\tau]$ of substitution programs.
% \end{proof}

% The proof of the following result follows from the standard `unrolling' of the
% fixed-point operators. For more detail please see~\cite{}.

% \begin{lem}
%   Let $\setop$ be a set of operators. If a query can be defined in
%   $\FP^{\nats} (\setop)$ then it can be defined by a $\PT$-uniform family of
%   $\FO^{\nats} (\setquant)$ substitution programs with constant program-width
%   and relation-width.
% \end{lem}

Let $L$ be a logic with constant definable-number width. Let $\rho$ be a
vocabulary. We say that a $\PT$-uniform family of $L[\rho]$-substitution
programs $(\Phi_n)_{n \in \nats}$ is \emph{bounded} if there is a constant $k
\in \nats$ such that for each $n \in \nats$ the definable-number width and
length of each formula in $\Phi_n$ is less than $k$. We aim to show that every
bounded $\PT$-uniform family of $\exlogic{\FO^{\nats}}{\setop}$-substitution
programs can be translated to equivalent $\PT$-uniform families of
$\FO(\setquant)$-substitution programs. We define a translation for a bounded
$\PT$-uniform family of $\exlogic{\FO^{\nats}}{\setop}$-substitution programs
$(\Theta_n)_{n \in \nats}$ in two parts. We show in
Lemma~\ref{lem:translate-program-line} that for each $n \in \nats$ we can expand
each formula in $\Theta_n$ into an equivalent sequence of
$\FO(\setquant)$-formulas. We then show in
Lemma~\ref{lem:translate-sub-operators-to-queries} that by expanding each
formula in $\Theta_n$ and then concatenating the resultant sequence we can
define a $\PT$-uniform family of $\FO(\setquant)$-substitution programs that
defines the same query as $(\Theta_n)_{n \in \nats}$.

We first define what it means to expand a formula in a substitution program into
an equivalent sequence of formulas. Let $\rho$ be a vocabulary and let $\setop$
be a set of operators that act on formulas. Let $\setquant$ be the corresponding
set of extended quantifiers. Let $\theta (\vec{x}, \vec{\mu}; \vec{V})$ be a
formula in $\exlogic{\FO^{\nats}}{\setop}[\rho]$ defined in terms of a sequence
of mixed-sort second-order variables $\vec{V} = (V_1, \ldots, V_v)$. For each $i
\in [v]$ let $v_i$ and $m_i$ be the arity of the element sort and number sort of
$V_i$, respectively. For each $n \in \nats$, $i \in [v]$, and $\vec{c} \in
\numdompow{n}{m_i}$ let $V^n_{i, \vec{c}}$ be an element-sort second-order
variable with arity $v_i$. For each $n \in \nats$ let $\vec{W}^n := \{ V^n_{i,
  \vec{c}} : i \in [v], \vec{c} \in \numdompow{n}{m_i}\}$ and let
$\boldsymbol{\theta}_n = (\theta_{n; \beta}(\vec{x}, \vec{W}^n))_{ \beta \in
  \numdompow{n}{\vec{\mu}}}$ be a sequence of
$\exlogic{\FO}{\setquant}[\rho]$-formulas. For $n \in \nats$. We say
$\boldsymbol{\theta}_n$ \emph{translates $\theta$ for $n$} if for all
\begin{myenum}
\item $\mathcal{A} \in \fin{\rho, n}$;
\item assignments $\alpha \in A^{\vec{x}}$ and $\beta \in
  \numdompow{n}{\vec{\mu}}$; and
\item \label{obj:trans-con-SO}assignments $\gamma$ and $\gamma'$ to the
  second-order variables, where $\gamma$ maps each $V_i$ to a relation
  $V^{(\mathcal{A}, \gamma)}_i \subseteq A^{v_i} \times \numdompow{n}{m_i}$ and
  $\gamma'$ maps each $V^n_{i, \vec{c}}$ to the relation $(V^{n}_{i,
    \vec{c}})^{(\mathcal{A}, \gamma')} \subseteq A^{v_i}$ such that $(\vec{a},
  \vec{c}) \in V^{(\mathcal{A}, \gamma)}_{i}$ if, and only if, $\vec{a} \in
  (V^{n}_{i, \vec{c}})^{(\mathcal{A}, \gamma')}$, we have
\end{myenum}
\vspace{-2.8mm}
\begin{align*}
  \mathcal{A} \models \theta [\alpha , \beta, \gamma]  \iff \mathcal{A} \models \theta_{n;\beta} [\alpha, \gamma'].
\end{align*}

We say $\boldsymbol{\theta} := (\boldsymbol{\theta}_{n})_{n \in \nats} =
(\theta_{n; \beta})_{n \in \nats, \beta \in \numdompow{n}{\vec{\mu}}}$
\emph{translates $\theta$} if $\boldsymbol{\theta}_n$ translates $\theta$ for
all $n \in \nats$. We similarly define a \emph{translation} for number-terms.
Let $\eta(\vec{x}, \vec{\mu}; \vec{V})$ be a number term. For each $n \in \nats$
let $\boldsymbol{\theta}^{\eta}_n := (\theta^\eta_{n, k; \beta})_{k \in \nats,
  \beta \in \numdompow{n}{\vec{\mu}}}$ be a sequence of
$\exlogic{\FO}{\setquant}[\rho]$-formulas. We say $\boldsymbol{\theta}^{\eta}_n$
\emph{translates} $\eta$ for $n \in \nats$ if for all $k \in \nats$ and all
$\mathcal{A}$, $\alpha$, $\beta$, $\gamma$, and $\gamma'$ defined as above we
have
\begin{align*}
  \eta^{(\mathcal{A}; \alpha, \beta, \gamma)} = k \iff \mathcal{A} \models \theta^{\eta}_{n, k; \beta}[\alpha, \gamma'].
\end{align*}

We say $\boldsymbol{\theta}^{\eta} := (\boldsymbol{\theta}^{\eta}_{n})_{n \in
  \nats} = (\theta^\eta_{n, k; \beta})_{n, k \in \nats, \beta \in
  \numdompow{n}{\vec{\mu}}}$ if $\boldsymbol{\theta}^{\eta}_n$ translates $\eta$
for all $n \in \nats$. We now show that a formula that appears in a
$\exlogic{\FO^\nats}{\setop}$-substitution program may be translated to a
sequence of $\exlogic{\FO}{\setquant}$-formulas, where $\setquant$ is the set of
extended quantifiers associated with $\setop$. We also show that there is an
algorithm implementing this translation, and we present a bound on the running
time of this algorithm.

\begin{lem}
  \label{lem:translate-program-line}
  Let $\rho$ be a vocabulary. Let $\setop$ be a set of operators that act on
  formulas and suppose $\exlogic{\FO^{\nats}}{\setop}$ has constant
  definable-number width. Let $\setquant$ be the corresponding set of extended
  quantifiers. Let $\theta(\vec{x}, \vec{\mu}; \vec{V}) \in
  \exlogic{\FO^{\nats}}{\setop}[\rho]$ be a formula defined in terms of the
  mixed-sort second-order variables $\vec{V} = (V_1, \ldots, V_v)$. Let $t$ be
  the definable-number width and $w$ be the number-variable width of $\theta$.
  
  There exists a sequence $\boldsymbol{\theta} := (\boldsymbol{\theta}_n)_{n \in
    \nats} = (\theta_{n; \beta}(\vec{x}; \vec{W}^n))_{n \in \nats, \beta \in
    \numdompow{n}{\vec{\mu}}}$ in $\exlogic{\FO}{\setquant}[\rho]$ such that
  $\boldsymbol{\theta}$ translates $\theta$. Each formula in
  $\boldsymbol{\theta}$ has variable-width at most equal to the element-variable
  width of $\theta$. There is a constant $c$ such that the function that maps
  $(n, \theta)$ to $(\theta_{n; \beta})_{\beta \in \numdompow{n}{\vec{\mu}}}$ is
  computable in time at most $c^{\vert \cl{\theta} \vert} \cdot n^{c \cdot \vert
    \cl{\theta} \vert \cdot (t + w)}$.
\end{lem}
\begin{proof}
  Let $n \in \nats$. We aim to define a translation of $\theta$ for $n$ by
  induction on the structure of the formula. In other words, for a sub-formula
  or sub-number-term $\gamma(\vec{y}, \vec{\nu} ; \vec{V})$ of $\theta$ we
  suppose each sub-formula and sub-number-term of $\gamma$ has a translation for
  $n$ and then, if $\gamma$ is a number term, we define a sequence of
  $\exlogic{\FO}{\setquant}[\rho]$-formulas $\boldsymbol{\phi}^{\gamma}_n =
  (\phi^{\gamma}_{n, k; \beta}(\vec{y}; \vec{W}^n))_{k \in \maxnumdom{n}{t},
    \beta \in \numdompow{n}{\vec{\nu}}}$ that translates $\gamma$ for $n$ and
  otherwise $\gamma$ is a formula and we define a sequence
  $\boldsymbol{\phi}^{\gamma}_n = (\phi^{\gamma}_{n ; \beta}(\vec{y};
  \vec{W}^n))_{\beta \in \numdompow{n}{ \vec{\nu}}}$ that translates $\gamma$
  for $n$. In each of these formulas $\vec{W}^n = \{ V^n_{i, \vec{a}} : i \in
  [v], \vec{a} \in \numdompow {n}{m_i}\}$. In this proof we use $\gamma_1,
  \gamma_2, \ldots$ to denote the sub-formulas or sub-number-terms of $\gamma$
  and we use $\beta$ to denote an arbitrary assignment to the free number
  variables in $\gamma$.

  We first consider the base cases. Suppose $\gamma$ is a number-variable or a
  constant (i.e.\ $0$ or $1$). If $\gamma$ evaluates to $k$ under the assignment
  $\beta$ let $\phi^{\gamma}_{n, k; \beta} := T$ and otherwise let
  $\phi^{\gamma}_{n, k; \beta} := \bot$. Suppose $\gamma$ is an atomic formula
  or (non-number) term. If the free variables in $\psi$ are all element
  variables then let $\phi^{\gamma}_{n; \beta} := \gamma$. If $\gamma :=
  V_i(\vec{y}, \vec{\nu})$ for some $i \in [v]$ let $\phi^{\gamma}_{n;
    \beta}(\vec{y}) := V^n_{i, \beta(\vec{\nu})}(\vec{y})$. This suffices to
  give a translation of $\gamma$ for $n$ in the base cases.

  We now consider the multiplication case. The other arithmetic operations can
  be handled similarly. Suppose $\gamma(\vec{y}, \vec{\nu}; \vec{V})$ is a
  number term and suppose $\gamma(\vec{y}, \vec{\nu}; \vec{V}) =
  \gamma_1(\vec{y}_1, \vec{\nu}_1; \vec{V}) \cdot \gamma_2(\vec{y}_2,
  \vec{\nu}_2; \vec{V})$. Let $\beta_1 \in \numdompow{n}{\vec{\nu}_1}$ and
  $\beta_2 \in \numdompow{n}{\vec{\nu}_2}$ be compatible with $\beta$, then for
  each $k \in \maxnumdom{n}{t}$ let
  \begin{align*}
    \phi^{\gamma}_{n, k ; \beta} :=
    \uset{a, b \leq k}{ a \cdot b = k}{\bigvee}(\phi^{\gamma_1}_{n, a;
    \beta_1} \land \phi^{\gamma_2}_{n, b; \beta_2}).
  \end{align*}

  We now handle the less-than relation for number-terms. The equality relation
  may be handled similarly. Suppose $\gamma(\vec{y}, \vec{\nu}; \vec{V}) =
  \gamma_1(\vec{y}_1, \vec{\nu}_1; \vec{V}) \leq \gamma_2 (\vec{y}_2,
  \vec{\nu}_2 ; \vec{V})$. Let $\beta_1 \in \numdompow{n}{\vec{\nu}_1}$ and
  $\beta_2 \in \numdompow{n}{\vec{\nu}_2}$ be compatible with $\beta$, and let
  \begin{align*}
    \phi^{\gamma}_{n; \beta} := \uset{a, b \in \maxnumdom{n}{t}}{a \leq
    b}{\bigwedge} (\phi^{\gamma_1}_{n, a; \beta_1} \land \phi^{\gamma_2}_{n, b;
    \beta_2}).
  \end{align*}
  
  We now handle the conjunction case. The other logical connectives may be
  handled similarly. Suppose $\gamma(\vec{y}, \vec{\nu}; \vec{V}) =
  \gamma_1(\vec{y}_1, \vec{\nu} ; \vec{V}) \land \gamma_2 (\vec{y}_2,
  \vec{\nu}_2 ; \vec{V})$. Let $\beta_1 \in \numdompow{n}{\vec{\nu}_1}$ and
  $\beta_2 \in \numdompow{n}{\vec{\nu}_2}$ be compatible with $\beta$. Let
  $\phi^{\gamma}_{n ; \beta} := \phi^{\gamma_1}_{n ; \beta_1} \land
  \phi^{\gamma_2}_{n ; \beta_2}$.

  We now handle the operator case. Let $\Omega_{E, \ar} \in \setop$ and suppose
  \begin{align*}
    \gamma(\vec{y}, \vec{\nu}; \vec{V}) = \Omega_{E, \ar} [\vec{\pi}] [((\vec{x}^i_1 \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i} \vec{\mu}^i_{r_i})(\chi_i))_{i \in [r]}],
  \end{align*}
  where $\tau = (\{R_1, \ldots, R_r\}, \{s_1, \ldots, s_q\}, \zeta)$ is the
  vocabulary of $\Omega_{E, \ar}$. Suppose $\Omega_{E, \ar}$ is a number-valued
  generalised operator. Let $k \in \nats$. Let $m$ be the parameter-width of
  $\Omega_{E, \ar}$. For each $\vec{p} \in [(n+1)^t - 1]^m_0$ and $k \in \nats$
  we have a extended-quantifier $Q^{n, \vec{p}, k}_{E, \ar} \in \setquant$. All
  of these extended quantifiers have the same number domain. Let $T := (T_i,
  \ldots, T_r)$ be that number domain. For each $i \in [r]$ let $\Upsilon_i :
  T_i \ra \FO(\setquant)[\rho]$ be defined for each $(\vec{m}_1, \ldots,
  \vec{m}_{r_i}) \in T_i$ by $\Upsilon_i (\vec{m}_1, \ldots, \vec{m}_{r_i}) =
  \phi^{\chi_i}_{n; \beta_i}$, where $\beta_i$ is an assignments to all the free
  number variables in $\chi_i$ such that (i) $\beta_i$ agrees with $\beta$ for
  each variable in $\vec{\nu}$ not bound by the operator and (ii) $\beta_i$
  assigns $\vec{\mu}^i_{j}$ to $\vec{m}_j$ for each $j \in [r_i]$. For each $i
  \in [m]$ let $\alpha_i$ be an assignment to the free number variables in
  $\vec{\pi}(i)$ compatible with $\beta$. Let
  \begin{align*}
    \phi^{\gamma}_{n, k; \beta} := \bigvee_{p_1, \ldots, p_m  \in \maxnumdom{n}{t}}[(\bigwedge_{i \in [m]} \phi^{\pi(i)}_{n, p_i; \alpha_i}) \land Q^{n, (p_1, \ldots, p_m), k}_{E, \ar} ((\vec{x}^{j}_1, \ldots, \vec{x}^{j}_{r_j}) \cdot \Upsilon_j)_{j \in [r]}].
  \end{align*}
  
  The case where $\Omega_{E, \ar}$ is a Boolean operator can be handled
  analogously. We can think of the $\forall$ and $\exists$ quantifiers as
  generalised operators, and so these case are subsumed by the operator case.

  It is not hard to show that in each of these cases the constructed sequences
  of formulas satisfy the requirements for a translation.
  
  There is also an obvious recursive algorithm implementing the above
  construction. It can be shown by reviewing each of the above cases that the
  cost of computing the translation for a sub-formula or sub-number-term $\gamma
  (\vec{y}, \vec{\nu} ; \vec{V})$ is at most $(c_1 \cdot n^{c_2 \cdot
    (t_{\gamma} + w_{\gamma} )} \cdot X)$, where $c_1$ and $c_2$ are constants,
  $t_{\gamma}$ and $w_{\gamma}$ are the definable-number width and
  number-variable width of $\gamma$, respectively, and $X$ is the maximal cost
  of translating a sub-formula or sub-number-term of $\gamma$. It follow that
  for a given $n$ and $\theta$ we can construct a family of formulas
  $\boldsymbol{\theta}_n$ that translates $\theta$ for $n$ in at most $c^{\vert
    \cl{\theta} \vert}_1 \cdot n^{c_2 \vert \cl{\theta} \vert \cdot (t + w)}$.
  The result follows.
\end{proof}

% \begin{lem}
%   Let $\setop$ be a set of non-quotienting operators. Let $\setquant :=
%   \setquant_{\setop}$ be the corresponding set of extended quantifiers. If a
%   query can be defined by a $\PT$-uniform family of $\FO^{\nats} (\setop)$
%   substitution programs with constant program-width and relation-width then it
%   can be defined by a $\PT$-uniform family of $\FO (\setquant)$ substitution
%   programs.
% \end{lem}
% \begin{proof}
%   Let $\rho$ be a vocabulary. Let $I = (I_n : [M_n] \ra \FO^{\nats} \ra
%   \FO^{\nats}(\setop)[\tau])_{n \in \nats}$ be a $\PT$-uniform family of
%   substitution programs. Let $n \in \nats$. For each $w \in [M_n]$ let
%   $\theta_w (\vec{x}) := I_n(w)$. For each mixed-sort second-order variable
%   $V_i$ with arity $(v_i, m_i)$ we define a family of element-sort
%   second-order variables $\mathbb{V}_i = \{V_{i, \vec{a}} : \vec{a} \in
%   [n]^{m_i}\}$ such that $v_{i, \vec{a}}$ is the arity of $V_{i, \vec{a}}$.

%   Fix $w \in [M_n]$ and let $\theta_{n,w} (\vec{x}, \vec{\mu}) := I_n(w)$. We
%   aim to define for each number term $\eta(\vec{y}, \vec{\nu})$ appearing in
%   $\theta_w(\vec{x}, \vec{\mu})$ a sequence of $\FO(\setquant)[\rho]$-formulas
%   $\{\phi^{\eta}_{n, w; k; \beta}(\vec{y}))_{\beta \in [n]^{\vec{\nu}}}) :
%   \beta \in [n]^{\vec{\nu}}, k \in \nats\}$.
  
%   We say that a number term $\eta(\vec{y}, \vec{\nu})$ in
%   $\FO^{\nats}(\setop)$ has a \emph{translation for $n$} if there is a
%   sequence of $\FO(\setquant)$-formulas $(\phi^{\eta}_{n, k;
%   \beta}(\vec{y}))_{\beta \in [n]^{\vec{\nu}}}$ such that for each
%   $\rho$-structure $\mathcal{A}$ of size $n$ and for each assignment $\alpha
%   \in [n]^{\vec{y}}$ we have that $\mathcal{A} \models \phi^{\eta}_{n, k;
%   \beta}[\alpha]$ if, and only if, $\mathcal{a} \models (\eta = k)[\alpha \cup
%   \beta]$.

%   We say a formula $\psi(\vec{y}, \vec{\nu})$ in $\FO^{\nats}(\setop)$ has a
%   \emph{translation for $n$} if there is a sequence of
%   $\FO(\setquant)$-formulas $(\phi_{n; \beta} (\vec{y}))_{\beta \in
%   [n]^{\vec{\mu}}}$ such that each $\tau$-structure $\mathcal{A}$ of size $n$
%   and each assignment $\alpha \in [n]^{\vec{y}}$, we have that $\mathcal{A}
%   \models \phi_{n; \vec{\beta}}[\alpha]$ if, and only if, $\mathcal{A} \models
%   \phi[\alpha \cup \beta]$.

%   We aim to show that $\theta(\vec{x}, \vec{\mu})$ has a \emph{translation for
%   $n$} by induction on the structure of the formula. It is easy to see that if
%   $\eta(\vec{y}, \vec{\nu})$ is a number variable or a constant (i.e. $0$ or
%   $1$) then $\eta$ has a translation for $n$. We also have that if
%   $\psi(\vec{y})$ is a formula then $\psi(\vec{y})$ is its own translation for
%   $n$. If $psi(\vec{y}, \vec{\nu}) = V_i(\vec{y}, \vec{\nu})$ then the
%   assignment $\psi_{n; \beta}(\vec{y}) = V_{i, \beta(\vec{\nu})}$ defines a
%   translation for $n$.

%   Let $\eta(\vec{y}, \vec{\nu})$ be a number term and suppose all sub-formulas
%   and sub-number-terms of $\eta$ have a translation for $n$. Let $\beta \in
%   [n]^{\vec{\nu}}$. Suppose $\eta(\vec{y}, \vec{\nu}) = \eta_1(\vec{y}_1,
%   \vec{\nu}_1) \cdot \eta_2(\vec{y}_2, \vec{\nu}_2)$. Let $\beta_1 \in
%   [n]^{\vec{nu}_1}$ and $\beta_2 \in [n]^{\vec{nu}_2}$ be assignments
%   compatible with $\beta$. Let $\psi^{\eta}_{n, k ; \beta} (\vec{y}) =
%   \underset{a, b \leq k, a \cdot b = k}{\bigvee}(\psi^{\eta)_1}_{n, a;
%   \beta}(\vec{x}) \land \psi^{\eta_2}_{n, b; \beta}(\vec{x}))$. The other
%   arithmetic cases are handled similarly.

%   We now consider the application of an operator. Let $\Omega \in \setop$ and
%   suppose

%   \begin{align*}
%     \eta(\vec{y}, \vec{\nu}) = \Omega_{E} [\vec{\pi}] [((\vec{x}^i_1
%     %     \vec{\mu}^i_1, \ldots, \vec{x}^i_{r_i}
%     %     \vec{\mu}^i_{r_i})(\chi_i))_{i \in [l]}].
%   \end{align*}
%   For each $i \in [l]$ let $T_i = [n]^{c_1} \times , \ldots, \times
%   [n]^{c_{r_i}}$. Let $T$ be a function that maps $i \in [l]$ to $T_i$. where
%   $c_{j}$ is the arity of ...x
%   \begin{align*}
%     \psi^{\eta}_{n, k; \beta}(\vec{x}) := \bigvee_{p_1, \ldots, p_{\vert
%           %     \vec{\pi} \vert}, e \leq M}[&(\bigwedge_{i \leq \vert
%           %     \vec{\pi}\vert} \psi^{\pi_{i}}_{n, p_i; \beta}(\vec{x})) \\
%           %     &\land
%           %     Q_{E, T ; (p_1, \ldots, p_n); e} ((\vec{x}^{j, \vec{t}}_1,
%           %     \ldots,
%           %     \vec{x}^{j, \vec{t}}_{r_i}) \cdot (\chi_{i, \vec{t}})_{ n;
%           %     \beta})_{j \in [l], \vec{t} \in T_j}]
% \end{align*}
% \end{proof}
Let $L$ be a logic with constant numeric-width. Let $\rho$ be a vocabulary. We
say that a $\PT$-uniform family of $L[\rho]$-substitution programs $(\Phi_n)_{n
  \in \nats}$ is \emph{bounded} if there is a constant $k \in \nats$ such that
for each $n \in \nats$ the definable-number width and length of each formula in
$\Phi_n$ is at most $k$.

\begin{lem}
  Let $\rho$ be a vocabulary and let $\setop$ be a set of operators that act on
  formulas and such that $\exlogic{\FO^{\nats}}{\setop}$ has constant
  definable-number width. Let $\setquant$ be the corresponding set of
  quantifiers. If a query can be defined by a bounded $\PT$-uniform family of
  $\exlogic{\FO^{\nats}}{\setop}[\rho]$-substitution programs then it can be
  defined by a $\PT$-uniform family of
  $\exlogic{\FO}{\setquant}[\rho]$-substitution programs with a constant bound
  on the variable-width.
  \label{lem:translate-sub-operators-to-queries}
\end{lem}
\begin{proof}
  Let $\Theta := (\Theta_{n})_{n \in \nats}$ be a bounded $\PT$-uniform family
  of $\exlogic{\FO^{\nats}}{\setop}[\rho]$-substitution programs. For each $n
  \in \nats$ let $M_n := \dom(\Theta_n)$. For each $n \in \nats$, $i \in M_n$
  let $\vec{x}^n_i$ and $\vec{\mu}^n_i$ be the free element variables and number
  variables in $\Theta_n(i)$ and let $V^n_i$ be the second-order variable
  associated with $\Theta_n(i)$. Note that $V^n_i$ has the same type as
  $(\vec{x}^n_i, \vec{\mu}^n_i)$. For each $n \in \nats$, $i \in M_n$, and
  $\vec{c} \in \numdompow{n}{\vert \vec{\mu}^n_i \vert}$ let $V^n_{i, \vec{c}}$
  be an element-sort second-order variable with arity $\vert \vec{x}^n_i\vert$
  and let $\theta_{n, i}(\vec{x}^n_i, \vec{\mu}^n_i; \vec{V}^n_i) :=
  \Theta_n(i)$, where $\vec{V}^n_i = (V^n_j)_{j > i}$. It follows from
  Lemma~\ref{lem:translate-program-line} that there exists
  $\boldsymbol{\theta}_{n, i} := (\theta_{n, i; \beta} (\vec{x}^n_i
  ,\vec{\mu}^n_i ; \vec{W}^n_{i}))_{\beta \in \numdompow{n}{\vec{\mu}^n_i}}$
  that translates $\theta_{n, i}$ for $n$ and where $\vec{W}^n_i = \{V^{n}_{j,
    \vec{c}} : j \in M_n, j > i, \vec{c} \in \numdompow{n}{\vert \vec{\mu}^n_j
    \vert}\}$.

  % It also follows from Lemma~\ref{lem:translate-program-line} and
  % the fact that $\Theta$ is bounded that there is a an algorithm that runs in
  % time polynomial in $n$ and that takes as input the formula $\theta_{n, i}$,
  % and outputs $\boldsymbol{\theta}_{n, i}$.

  Let $M_n' := \{(i, \vec{c}) : i \in M_n, \vec{c} \in \numdompow{n}{\vert
    \vec{\mu}^n_i \vert}\}$. Let $\Theta_n' : M_n' \ra
  \exlogic{\FO}{\setquant}[\rho]$ be defined such that for each $(i, \vec{c})
  \in M_n'$ and $\beta := \assign{\vec{\mu}^n_i}{\vec{c}}$ we have $\Theta_n'
  (i, \vec{c}) := \theta_{n, i; \beta}$. Let $\Theta' = (\Theta_n')_{n \in
    \nats}$. Since $M_n'$ is a product of two linearly ordered sets, we can
  define a linear order on $M_n'$ lexicographically. For each $(i, \vec{c})\in
  M_i'$ we associate the formula $\Theta_n'(i, \vec{c})$ with the second-order
  variable $V^n_{i, \vec{c}}$. For each $(i, \vec{c})\in M_i'$ the second-order
  variables that appear in $\Theta_n'(i, \vec{a})$ are among $\vec{W}^n_i
  \subseteq \{V^n_{j, \vec{b}} : (j, \vec{b}) \in M_i', \, (j, \vec{b}) > (i,
  \vec{c}))\}$. It follows that $\Theta_n'$ is a valid substitution program.

  % Then $i \geq j$.

  % Then $\theta_{n, i}$ does not contain the second-order variable $V^n_{j}$.
  % It fo

  % Let $\beta_1$ be an assignment that maps $\vec{\mu}^n_i$ to $\vec{a}$
  % $\theta_{n, i ; \beta}$ is defined in terms of $\vec{W}^n_i$ and $V^n_{j,
  % \vec{b}} \not\in \vec{W}^n_i$. It follows that

  % the definition of a translation it follows that for all $\vec{d} \in
  % \numdompow{n}{\vert \vec{\mu}^n_i \vert}$ and $\vec{e} \in
  % \numdompow{n}{\vert \vec{\mu}^n_j \vert}$ the translation $\theta_{n, i ;
  % \beta}$, where $\beta$ is the assignment that maps $\vec{\mu}^n_i$ to
  % $\vec{d}$, does not contain the second-order variable $V^n_{j ; \vec{e}}$.

  
  % Moreover, for a fixed $n \in \nats$ and $i \in M_n$ all of the formulas in
  % $\boldsymbol{\theta}_{n, i}$ are defined in terms of the same set of
  % second-order variables. It follows that for all $(i, \vec{a}), (j, \vec{b})
  % \in M_n'$, $(i, \vec{a}) < (j, \vec{b})$ $\Theta_n'(i, \vec{a})$ does not
  % contain the second-order variable $V^n_{j; \vec{b}}$. In other words,
  % $\Theta_n'$ is a well-formed substitution program.

  \begin{claim}
    For each $n \in \nats$ let $\theta_n(\vec{x}^n_1, \vec{\mu}^n_1)$ be the
    flattening of $\Theta_n$ and for each $\vec{c} \in \numdompow{n}{\vert
      \vec{\mu}^n_1\vert}$ let $\theta_{n, \vec{c}}'(\vec{x}^n_1)$ be the
    flattening of $\Theta_n'$ at $(1, \vec{c})$. Then for all $n \in \nats$,
    $\mathcal{A} \in \fin{\rho, n}$, $\alpha \in A^{\vec{x}^n_1}$, and $\beta
    \in \numdompow{n}{\vec{mu}^n_1}$ we have $\mathcal{A} \models \theta_n
    [\alpha, \beta]$ if, and only if, $\mathcal{A} \models \theta_{n,
      \beta(\vec{\mu}^n_1)}[\alpha]$.
  \end{claim}
  \begin{proof}
    Let $n \in \nats$. For each $i \in M_n$ let $\phi_{n, i}$ be the flattening
    of $\Theta_n$ at $i$ and for each $\vec{c} \in \numdompow{n}{\vert
      \vec{\mu}^n_i\vert}$ let $\phi_{n, (i, \vec{c})}'$ be the flattening of
    $\Theta_n'$ at $(i, \vec{c})$. Let $i \in M_n$. We aim to show for all
    $\mathcal{A} \in \fin{\rho, n}$, $\alpha \in A^{\vec{x}^n_i}$, and $\beta
    \in \numdompow{n}{\vec{\mu}^n_i}$ we have $\mathcal{A} \models \phi_{n,
      i}[\alpha, \beta]$ if, and only if, $\mathcal{A} \models \phi_{n, (i,
      \beta(\vec{\mu}^n_1))}[\alpha]$. We prove the result by backwards
    induction.

    % Let $n \in \nats$, $(i, \vec{a}) \in M_n'$ let $M_{n, (i, \vec{a})}' =
    % \{(j,
    % \vec{b}) : (i, \vec{a}) \leq (j, \vec{b})\}$ and let $M_{n, i} = \{j : i
    % \leq j\}$. Let $\Psi_{n, (i, \vec{a})}'$ be the restriction of $\Theta_n'$
    % to $M_{n, (i, \vec{a})}$ and let $\Psi_{n, i}$ be the restriction of
    % $\Theta_n$ to $M_{n, i}$. We now prove that for each $(i, \vec{a}) \in
    % M_n'$
    % the flattening of $\Psi_{n, \vec(i, \vec{a})}'$ defines the same query as
    % the flattening of $\Psi_{n, i}$ with the assignment that $\vec{\mu}^n_i$
    % to
    % $\vec{a}$. The proof is by backwards induction. Let $i \in M_n$ and let
    % $\vec{a} \in [n]^{\vert \vec{\mu}^n_i \vert}$. Let $\phi_{n, i}$ be the
    % flattening of $\Phi_{n, i}$ and let $\phi_{n, (i, \vec{a})}$ be the
    % flattening of $\Phi_{n, (i, \vec{a})}$. Let $\mathcal{A} \in \fin[\rho,
    % n]$
    % and suppose we have assignments $\alpha \in A^{\vec{x}^n_i}$ and $\beta$
    % that maps $\vec{\mu}^n_i$ to $\vec{a}$.

    Suppose $i = \max(M_n)$. Then no second-order variables appear in
    $\Theta_n(i)$ and for all $\vec{c} \in \numdompow{n}{\vert
      \vec{\mu}^n_i\vert}$ no second-order variables appear in $\Theta_n'(i,
    \vec{c})$. It follows that for all $\vec{c} \in \numdompow{n}{\vert
      \vec{\mu}^n_i\vert}$ we have $\phi_{n, i} = \Theta_n(i)$ and $\phi_{n, (i,
      \vec{c})}' = \Theta_{n}'(i, \vec{c})$. We thus have $\mathcal{A} \models
    \phi_{n, i}[\alpha, \beta]$ if, and only if, $\mathcal{A} \models
    \Theta_{n}(i)[\alpha, \beta]$ if, and only if, $\mathcal{A} \models
    \Theta_{n}'(i, \beta(\vec{\mu}^n_i)) [\alpha]$ if, and only if, $\mathcal{A}
    \models \phi_{n, (i,\beta(\vec{\mu}^n_i))}'[\alpha]$. The second equivalence
    follows from the definition of a translation and from the fact that no
    second-order variables appear in either of these formulas. The base case
    follows.

    Suppose $i < \max(M_n)$ and the hypothesis holds for all $j > i$. Let
    $\gamma$ be an assignment to second-order variables that maps each $V^n_j$
    with $j > i$ to the relation $(V^n_j)^{(\mathcal{A}, \gamma)} :=
    \phi^{\mathcal{A}}_{n, j}$. Let $\gamma'$ be the assignment to second-order
    variables that maps each $V^n_{j, \vec{c}}$ with $j > i$ and $\vec{c} \in
    \numdompow{n}{\vert \vec{\mu}^n_j \vert}$ to the relation $(V^n_{j,
      \vec{c}})^{(\mathcal{A}, \gamma')} := (\phi_{n, (j,
      \vec{c})}')^{\mathcal{A}}$. From the induction hypothesis we have for all
    $j > i$, $\alpha_j \in A^{\vec{\mu}^n_j}$, and $\beta_j\in
    \numdompow{n}{\vec{\mu}^n_j}$ that $\mathcal{A} \models \phi_{n, j}[\alpha,
    \beta]$ if, and only if, $\mathcal{A} \models \phi_{n, (j,
      \beta_j(\vec{\mu}^n_j))}' [\alpha]$. It follows from the definition of
    $\gamma$ and $\gamma'$ that for all $(\vec{a}, \vec{c}) \in A^{\vert
      \vec{x}^n_j\vert} \times \numdompow{n}{\vert \vec{\mu}^n_j \vert}$ we have
    $(\vec{a}, \vec{c}) \in (V^n_{j})^{(\mathcal{A}, \gamma)}$ if, and only if,
    $\vec{a} \in (V^n_{j, \vec{c}})^{(\mathcal{A}, \gamma')}$. In other words
    $\gamma$ and $\gamma'$ satisfy condition~\ref{obj:trans-con-SO} in the
    definition of a translation. We note that $\gamma$ maps each second-order
    variable $V^n_{j}$ to the flatting of $\Theta_n$ at $j$ and $\gamma'$ maps
    each second-order variable $V^n_{j, \vec{c}}$ to the flatting of $\Theta_n'$
    at $(j, \vec{c})$. It follows that
    \begin{align*}
      \mathcal{A} \models \phi_{n, i} [\alpha, \beta] \iff \mathcal{A} \models \theta_{n, i}[\alpha, \beta, \gamma] \iff \mathcal{A} \models \theta_{n, i ; \beta}[\alpha, \gamma'] \iff \mathcal{A} \models \phi_{n, (i, \vec{c})}[\alpha].
    \end{align*}
    The first and third equivalences follow from the definition of a flattening
    and the second equivalence follows from the definition of a translation for
    $n$. The claim follows by induction.
  \end{proof}

  We have for each $n \in \nats$ that $\Theta_n(1)$ has no free number
  variables. Let $\theta_n$ and $\theta_n'$ be the flattenings of $\Theta_n$ and
  $\Theta_n'$. It follows that no free number variables appear in $\theta_n$ and
  $\theta_n'$. Then, from the claim, we have that $\mathcal{A} \models
  \theta_n[\alpha]$ if, and only if $\mathcal{A} \models \theta_n'[\alpha]$ for
  each $\mathcal{A} \in \fin{\rho, n}$ and assignment $\alpha \in
  A^{\vec{x}^n_1}$. In other words $\Theta'$ and $\Theta$ defines the same
  query.

  Since $\Theta$ is $\PT$-uniform, the function that maps $n$ to $\Theta_n$ is
  computable in time polynomial in $n$. From
  Lemma~\ref{lem:translate-program-line} the function that maps each
  $\Theta_n(i)$ (for $n \in \nats$, $i \in M_n$) to the translation of
  $\Theta_n(i)$ for $n$ is computable in time polynomial in $n$. It follows that
  the function $n \mapsto \Theta_n'$ is computable in time polynomial in $n$.
  Since $\Theta$ is bounded, it follows that there is a constant bound on the
  variable-width, and hence, from Lemma~\ref{lem:translate-program-line}, there
  is a constant bound on the variable-width of $\Theta'$. In summary, we have
  that $\Theta'$ is a $\PT$-uniform family of
  $\exlogic{\FO}{\setquant}[\rho]$-substitution programs with a constant bound
  on the variable-width and $\Theta'$ defines the same query as $\Theta$. The
  result follows.
\end{proof}

\section{Infinitary Logics}
\label{chpt:gen-op--sec:fp-to-inf}
We now complete the translation from fixed-point logics with generalised
operators to bounded-variable infinitary logics with extended
quantifiers. % We first define what it means to extend an infinitary logic by an
% extended quantifier.

% Let $Q^{n}_{D, \ar}$ be an extended quantifier with number-domain $T = (T_1,
% \ldots, T_r)$ and vocabulary $\tau := (\{R_1, \ldots, R_r\}, \{s_1, \ldots,
% s_q\}, \zeta)$. We define the extension of $\mathcal{C}^k$ by $Q^n_{D, \ar}$
% by extending the formula formation rules for $\mathcal{C}^k$ with the
% following rule:
% \begin{textbox}[14.0cm]
%   Let $Q^{n}_{D, \ar} \in \setquant$ with number-domain $T = (T_1, \ldots,
%   T_r)$ and vocabulary $\tau := (\{R_1, \ldots, R_r\}, \{s_1, \ldots, s_q\},
%   \zeta)$.

%   Let $\Upsilon_i : T^i_n \ra L(\setquant)$.

%   $i \in [r]$, $l \in [r_i]$ let $c^i_l = \ar(\zeta(R_i)(l), 2)$ and let
%   $T^i_n := [n]^{c^i_l} \times , \ldots, \times [n]^{c^i_{r_i}}$. Let $T_n$ be
%   the function that maps $i \in [r]$ to $T^i_n$. Let $\Upsilon_i : T^i_n \ra
%   L(Q^{E, \ar}_{\vec{p}, n})$. For each $i \in [r]$ and $l \in [r_i]$ let $s =
%   \zeta (R_i)(l)$ and let $\vec{x}^i_l$ be an $\ar(s, 1)$-length tuple of
%   element variables. Then $Q^{E, \ar}_{\vec{p}, n} [(\vec{x}^i_1, \ldots,
%   \vec{x}^i_{r_i}) \cdot \Upsilon_i]_{i \in [r]}$ is a formula in
%   $\mathcal{L}(\setquant)$.
% \end{textbox}

\begin{prop}
  Let $\setop$ be a set of operators that act on formulas and let $\setquant$ be
  the corresponding set of extended quantifiers. Let $\rho$ be a vocabulary.
  Every query definable in $\exlogic{\FP^{\nats}}{\setop}[\rho]$ can be defined
  by a formula of the form
  \begin{align*}
    \phi (\vec{x}) := \bigwedge_{n \in \nats}(\exists^{=n}x . \, x = x) \land \phi_n(\vec{x}),
  \end{align*}
  where for all $n \in \nats$ we have $\phi_n \in
  \exlogic{\FO}{\setquant}[\rho]$. It follows that
  $\exlogic{\FP^{\nats}}{\setop} \leq
  \exlogic{\mathcal{C}^{\omega}}{\setquant}[\rho]$.
  \label{prop:FP-to-inf}
\end{prop}
\begin{proof}
  From Lemma~\ref{lem:translate-sub-operators-to-queries} there exists a
  $\PT$-uniform family of $\exlogic{\FO}{\setquant}[\rho]$-substitution programs
  $(\Phi_n)_{n \in \nats}$ with a constant bound on the variable-width. For each
  $n \in \nats$ let $\phi_n$ be the flattening of $\Phi_n$. Then there exists $w
  \in \nats$ such that each $\phi_n$ has at most $w$ free variables. We can
  rename variables such that each $\phi_n$ has free variables among some
  sequence of $w$-length sequence of variables $\vec{x}$. The result follows.
\end{proof}

% \section{Counting and Rank Operators}
% We have defined a general framework for working with operators and quantifiers
% and proved that the translation from fixed-point logics to infinitary logics
% can be generalised. We now discuss a few examples of logics that are defined
% as extensions of fixed-point with counting by some operator and show


% \section{Important Examples and Interesting Classes}
% We have developed a theory of generalised operators and shown that each family
% of generalised operators can be associated with a family of extended
% quantifiers. We have also showed that each formula in an extension of $\FP$ by
% a family of operators is equivalent to a formula is the extension of
% $\mathcal{L}$ by the associated family of extended quantifiers. We consider a
% few important logics as examples. These logics will also act as

% with a family and shown that fixed-point logics extended by generalised
% operators can be thought of as formulas in an some in


% \begin{definition}
%   Let $\setop$ be a set of operators. Let $L$ be an extension of
%   $\FO^{\nats}$. Let $T_1$ and $T_2$ be function that map operators to
%   operators such for each $\Omega \in \setop$ if $E$ and $\ar$ are the
%   evaluation and arity functions of $\Omega$ and for $\ar_1, \ar_2 : \dom(\ar)
%   \ra \nats$ are defined such that for each $(s, i) \in \dom (\ar)$, $\ar_1
%   (s, i) = \ar (s, i)$ and $\ar_2 (s, i) = 0$ if $i = 1$, otherwise $\ar_1 (s,
%   i) = 0$ and $\ar_2 (s, i) = \ar(s, i)$ and for each $i \in [2]$, $T_i
%   (\Omega) = \Omega_{E, \ar_i}$. We call $\restr{\setop}{1} = T_1 (\setop)$
%   the \emph{projection of $\setop$ to element-sort} and $\restr{\setop}{2} =
%   T_2 (\setop)$ the \emph{projection of $\setop$ to number-sort}. We say that
%   $\setop$ is \emph{element grounded in $L(\setop)$} if $L(\setop) \equiv
%   L(\restr{\setop}{1})$. We say that $\setop$ is \emph{number grounded in
%   $L(\setop)$} if $L(\setop) \equiv L(\restr{\setop}{2})$.

%   Let $T^{\text{Sep}}$ be a function on $\setop$ defined such that for each
%   $\Omega \in \setop$ if $E$ and $\ar$ are the evaluation and arity functions
%   of $\Omega$ then $T^{\text{Sep}}$ is the set of all $\Omega_{E, \ar'}$ where
%   $\ar' : \dom (\ar) \ra \nats$ is defined such that for each symbol $s$ in
%   the vocabulary of $\Omega$, $\sum_{i \in [2]} \ar' (s, i) \leq 1$. Let
%   $\setop^{\text{Sep}} = \bigcup_{\Omega \in \setop} T^{\text{Sep}}(\Omega)$.
%   We say that $\setop$ is \emph{separable in $L(\setop)$} if $L(\setop) \equiv
%   L(\setop^{\text{Sep}})$.


% \end{definition}

% \section{Operators and Descriptive Complexity}
% Dawar~\cite{} has shown that if there is a logic that captures $\PT$ then
% there is an extension of $\FO$ with uniform families of quantifiers that
% captures $\PT$. We now re-frame this result within the generalised operator
% framework. We also show that any logic that captures $\PT$ must be closed
% under operator quotients.

% \begin{lem}
%   Let $\setop$ be a set of Boolean generalised operators. Let $L$ be a logic
%   and suppose $\exlogic{\FO}{\setop} \leq \PT$. Then $L^{\nats}(\Omega) \leq
%   \PT$.
% \end{lem}
% \begin{proof}
%   For each $\phi \in \exlogic{\FO}{\Omega}$ let $(M_\phi, p_\phi)$ be the
%   corresponding Turing machine and polynomial pair. We aim to show that for
%   each $\psi \in FOC(\Omega)$ there is a corresponding Turing machine
%   $M_{\psi}$ and polynomial $p_\psi$ such that $M_\psi$ decides query defined
%   by $\psi$ and runs in time bounded by the polynomial $p_\psi$. The function
%   that maps formulas to machine and polynomial pairs must also be computable.

%   We prove this by induction on the structure of a formula. It is easy to
%   prove the result for

  
%   We wish to show that each formula in $\FOC(\Omega)$ defines a query


%   Let $\phi \in \FOC(\Omega)$. The base cases follow from the fact that if
%   $\phi \in \FOC[\rho]$ then $\phi \in \exlogic{\FOC}{\Omega} \leq \PT$. The
%   only interesting case is where $\phi := $

%   Let $\phi \in \FOC(\Omega)$.

  
%   If $\FO(\Omega) \leq \PT$ then for each $\phi \in \FO(\Omega)[\rho]$ there
%   is
% \end{proof}

% \begin{prop}
%   If there is a logic that captures $\PT$ then there is a set of Boolean
%   generalised operators $\setop$ such that $\FOC(\setop)$ captures $\PT$ and
%   $\FOC(\setop)$ is closed under operator quotients.
%   \label{prop:P-uniform-quantifiers}
% \end{prop}
% \begin{proof}
%   We have from Dawar~\cite{} that if there Suppose there is a logic that
%   captures $\PT$. It follows from Dawar~\cite{} that there exists a uniform
%   sequence of Lindestrom quantifiers $\setquant = (Q_n)_{n \in \nats}$ such
%   that $\FO(\setquant) \equiv \PT$. It is easy to see that if we extend


%   It follows from Dawar~\cite{} that there is a uniform operator $\setop_E$
%   such that $\exlogic{FO}{\setop_E}$ captures $\PT$. From Lemma~\ref{} it
%   follows that $\PT \leq \exlogic{\FO}{\setop_E} \leq \FO(\setop_E) \leq
%   \FOC(\setop_E) \leq \PT$. Also, $\PT \leq \exlogic{\FO}{\setop_E} \leq
%   \exlogic{\FOC}{\setop_E} \leq \PT$ follows that $\exlogic{\FOC}{\setop_E}
%   \equiv \PT \equiv \FOC(\setop_E)$.
% \end{proof}




\end{document}


%  LocalWords:  correpsonding
 